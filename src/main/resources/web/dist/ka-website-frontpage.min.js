function search_fulltext_geo_objects(){query=kiezatlas.get_fulltext_search_input(),query.length>=1&&(query=encodeURIComponent(query,"UTF-8"),kiezatlas.is_angebote_mode()?kiezatlas.do_text_search_angebotsinfos(query,!0):kiezatlas.do_text_search_geo_objects(query,void 0,!0))}function handle_fulltext_search_input(a){13===a.keyCode&&do_fulltext_search()}function do_fulltext_search(){query=kiezatlas.get_top_search_input(),query.length>=1&&($("#fulltext-search").val(query),kiezatlas.hide_sidebar(),kiezatlas.do_text_search_geo_objects(query,void 0,!0))}function cleanUpAddress(a){if(a)return a.replace(" Deutschland","")}function search_location_by_text(){var a=$("#near-by").val()+" Berlin, Deutschland";a=encodeURIComponent(a,"UTF-8"),$(".location-search-info").hide(),kiezatlas.district&&kiezatlas.clear_district_filter(),kiezatlas.show_spinning_wheel(!0),restc.do_geocode(a,function(a){kiezatlas.hide_spinning_wheel(!0),a.hasOwnProperty("results")?(kiezatlas.set_locationsearch_results(a.results),kiezatlas.set_autocomplete_item(0),1===a.results.length?(kiezatlas.focus_locationsearch_result(),$("#street-alternatives").hide()):a.results.length>1?(kiezatlas.focus_locationsearch_result(),kiezatlas.show_locationsearch_alternatives()):($(".location-search-info").html("Keinen Ort f&uuml;r diese Anfrage gefunden"),$(".location-search-info").show())):(console.warn("ERROR","x: "+x+" s: "+s+" e: "+e),$(".location-search-info").html('Es ist in Fehler bei der Suche aufgetreten bitte probieren sie es erneut. Sollte dieser Fehler wiederholt auftreten bitte informieren sie uns per Email unter <a href="mailto:support@kiezatlas.de">support@kiezatlas.de</a>.'),$(".location-search-info").show())})}function create_list_item(a){return null!=a?$('<li class="item" data-topic-id="'+a.id+'"><h3>'+a.name+', <span class="anschrift">'+a.anschrift.replace(" Deutschland","")+'</span>, <a href="javascript:citymap.show_selected_detail('+a.id+', true);">mehr Infos</a></h3></li>'):void console.log("Skipped creting null list item",a)}function hide_loading_indicator(){$(".citymap .ui.search button .icon").removeClass("loading").removeClass("circle").removeClass("notched"),$(".citymap .ui.search button .icon").addClass("search")}function show_loading_indicator(){$(".citymap .ui.search button .icon").addClass("loading").addClass("circle").addClass("notched"),$(".citymap .ui.search button .icon").removeClass("search")}var restc=function(a){function b(a,b){var c=a.value,d=b.value;return c.toLowerCase()>d.toLowerCase()?1:c.toLowerCase()<d.toLowerCase()?-1:0}console.log("REST Client Module (jQuery based) Loaded");var c={};return c.do_geocode=function(b,c){a.ajax({type:"GET",url:"/website/geocode?query="+b,success:function(a){c(a)},error:function(a,b,d){c(d)}})},c.create_location_string=function(a){return a.lng.toFixed(4)+", "+a.lat.toFixed(4)},c.get_places_nearby=function(b,d,e){var f=c.create_location_string(b),g=d;d||(g=750),a.getJSON("/website/search/"+encodeURIComponent(f)+"/"+g/1e3,e)},c.do_reverse_geocode=function(b,c,d){a.getJSON("/website/reverse-geocode/"+b.get_current_location_lat()+","+b.get_current_location_lng(),function(a){if(c&&c.hide_spinning_wheel(!0),a.results.length>0){var e=a.results[0],f=e.address_components,g={coordinates:""+b.get_current_location_lat()+","+b.get_current_location_lng()};for(var h in f){var i=f[h];"route"===i.types[0]?"undefined"!=typeof i.long_name&&(g.street=i.long_name):"sublocality_level_1"===i.types[0]?"undefined"!=typeof i.long_name&&i.long_name&&(g.district=i.long_name.replace("Bezirk ","")):"street_number"===i.types[0]?"undefined"!=typeof i.long_name&&i.long_name&&(g.street_nr=i.long_name):"locality"===i.types[0]?"undefined"!=typeof i.long_name&&i.long_name&&(g.city=i.long_name):"postal_code"===i.types[0]&&"undefined"!=typeof i.long_name&&i.long_name&&(g.postal_code=i.long_name)}var j=g.street+" ";g.street_nr&&(j+=g.street_nr+", "),g.district?j+=" "+g.district:g.city&&(j+=" "+g.city),b.set_current_location_name(j),c&&c.render_current_location_label(),d&&d(g)}})},c.load_current_angebotsinfos=function(b){a.getJSON("/angebote/locations",function(a){b(a)})},c.load_related_angebotsinfos=function(b,c){a.getJSON("/angebote/list/assignments/geo/"+b,function(a){c(a)})},c.load_view_permissions=function(b){a.getJSON("/website/menu",function(a){b(a)})},c.load_angebotsinfo=function(b,c){a.getJSON("/angebote/"+b+"/json",function(a){c(a)})},c.load_districts=function(c){a.getJSON("/website/bezirk",function(a){a.sort(b),c(a)})},c.load_search_keywords=function(b,c){var d="/website/search-keywords";b&&(d+="?query="+b),a.getJSON(d,function(a){c(a)})},c.load_district_topics=function(b,c){b&&!isNaN(b)?a.getJSON("/website/bezirk/"+b,function(a){c(a)}):c("No district ID given, skipping request id=",b)},c.load_district_regions=function(b,c){b&&!isNaN(b)?a.getJSON("/website/bezirk/"+b+"/bezirksregionen",function(a){c(a)}):c("No district ID given, skipping request id=",b)},c.load_website_geoobjects=function(b,c){a.getJSON("/website/"+b+"/geo",function(a){c(a)})},c.load_geo_objects_by_category=function(b,c,d){a.getJSON("/website/"+b+"/geo/"+c,function(a){d&&d(a)})},c.load_website_info=function(b,c){a.getJSON("/website/info/"+b,function(a){c(a)})},c.load_topics_by_type=function(b,c){a.getJSON("/core/topic/by_type/"+b,function(a){c(a)})},c.load_website_facets=function(b,c){a.getJSON("/site/"+b+"/facets/typedefs",function(a){c(a)})},c.load_websites=function(b){a.getJSON("/website/sites/json",function(a){b(a)})},c.remove_website_assignment=function(b,c,d){a.ajax({type:"DELETE",url:"/site/"+b+"/"+c,success:function(){d({state:"ok"})},error:function(a,b,c){d({state:"error",detail:c}),console.warn("Deleting geo-website assignment failed",a,b,c)}})},c.create_website_assignment=function(b,c,d){a.ajax({type:"POST",url:"/site/"+b+"/"+c,success:function(){d({state:"ok"})},error:function(a,b,c){d({state:"error",detail:c}),console.warn("Deleting geo-website assignment failed",a,b,c)}})},c.create_user_assignment=function(b,c,d){a.ajax({type:"POST",url:"/website/assign/"+b+"/"+c,success:function(){console.log("Successfully created a kiezatlas topic-user assignment"),d({state:"ok"})},error:function(a,b,c){d({state:"error",detail:c}),console.log("Creating a kiezatlas topic-user assignment failed",a,b,c)}})},c.delete_user_assignment=function(b,c,d){a.ajax({type:"DELETE",url:"/website/assign/"+b+"/"+c,success:function(){console.log("Successfully deleted kiezatlas topic-user assignment"),d({state:"ok"})},error:function(a,b,c){d({state:"error",detail:c}),console.log("Deleting kiezatlas topic-user assignment failed",a,b,c)}})},c.create_comment=function(b,c,d,e,f){a.ajax({type:"POST",url:"/website/comment/"+b+"/"+c+"/"+d+"/"+e,success:function(){console.log("Successfully created a kiezatlas topic-user assignment"),f({state:"ok"})},error:function(a,b,c){f({state:"error",detail:c}),console.log("Creating a kiezatlas topic-user assignment failed",a,b,c)}})},c.update_facets=function(b,c,d,e){a.ajax({type:"PUT",url:"/website/edit/"+c+"/facets/"+b,data:JSON.stringify(d),contentType:"application/json",success:function(){console.log("Successfully updated geo-objects site facets"),e({state:"ok"})},error:function(a,b,c){e({state:"error",detail:c}),console.log("Updating geo-website site facets failed",a,b,c)}})},c.load_news_items=function(b,c){a.getJSON("/website/newsfeed/"+b,function(a){c(a)})},c.load_facetted_geo_object=function(b,c,d){a.getJSON("/website/geo/"+b+"/facetted/"+c,function(a){a?d(a):console.warn("Error while loading details for core topic ",a)})},c.load_geo_object_detail=function(b,c){a.getJSON("/website/geo/"+b,function(a){a?c(a):console.warn("Error while loading details for geo object",a)})},c.logout=function(){a.post("/accesscontrol/logout",function(a){a||kiezatlas.render_user_menu(!1)})},c.is_logged_in=function(b){a.get("/accesscontrol/user",function(a){return a&&a.length>0?void b(!0):void b(!1)})},c.create_cookie=function(a,b,c){if(c){var d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3);var e="; expires="+d.toGMTString()}else var e="";document.cookie=a+"="+b+e+"; path=/"},c.read_cookie=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return null},c.erase_cookie=function(a){c.create_cookie(a,"",-1)},c}($),model={district:void 0,districts:[],locationsearch_results:[],autocomplete_item:0,view_angebote:!1,site_info:void 0,site_id:void 0,map_controls_results:!1,set_site_info:function(a){model.site_info=a},set_site_id:function(a){model.site_id=a},get_site_info:function(){return model.site_info},get_site_id:function(){return model.site_id},set_districts:function(a){model.districts=a},get_districts:function(){return model.districts},set_frontpage_mode:function(){model.set_site_info(void 0),model.set_site_id(void 0)},set_angebotsfilter:function(a){model.view_angebote=a},set_mapcontrol_mode_results:function(){model.map_controls_results=!0,leafletMap.deactivate_circle_control(),leafletMap.remove_circle_search_control()},set_mapcontrol_mode_query:function(a){model.map_controls_results=!1,leafletMap.is_circle_query_active()?leafletMap.render_circle_search_control(a):(leafletMap.activate_circle_control(),leafletMap.render_circle_search_control(a),console.log("Activating circle query control..."))},is_kiezatlas_site:function(){return model.siteId},is_map_result_control:function(){return model.map_controls_results},is_map_query_control:function(){return!model.map_controls_results},is_angebote_mode:function(){return model.view_angebote},month_names_de:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],colors:{ka_blue:"#3e606f",ka_red:"#ce0000",ka_green:"#9cc300",m_blue:"#9ec8d6",ka_gold:"#f8f6e9",bright_grey:"#a9a9a9",yellow:"#f8f6e9",darkgrey:"#343434",dark_blue:"#193441",bright_blue:"#ecf4f7",ka_water:"#ccdddd",grey:"#868686",ka_yellow:"#f8f6e9",blue1:"#193441",blue2:"#9ec8d6",blue3:"#3787ab",blue4:"#ecf4f7",blue5:"#3e606f"}},mapping={zoom_detail:15,zoom_street:14,zoom_kiez:13,zoom_district:12,zoom_city:11,marker_radius_fixed:!1,marker_radius:10,marker_radius_selected:15,circle_search_radius:750,circle_search_control:void 0,circle_query:!0,circle_locked:!0,current_location:{name:"Tucholskystraße, 10117 Berlin",coordinate:new L.latLng(52.524256,13.392192)},max_bounds:L.latLngBounds(L.latLng(52.234807,12.976094),L.latLng(52.84337,13.958482)),marker_group:void 0,control_group:L.featureGroup(),do_cluster_marker:!1,fit_bounds_padding:30,angebote_mode:!1},leafletMap=function(a,b){function c(){f.set_current_location_name('Ihr Standort liegt au&szlig;erhalb von Berlin, bitte nutzen sie die Umkreissuche oder <a href="javascript:kiezatlas.focus_location_input_field()" >die Texteingabe</a>.'),f.map.setView(f.get_current_location_coords()),f.map.setZoom(mapping.zoom_kiez),f.fire_location_error("Ihr Standort ist a&uszlig;erhalb von Berlin.")}function d(a,b,c){if(e){var d=document.createEvent("CustomEvent");d.initCustomEvent(b,!0,!1,c),a.dispatchEvent(d)}else a.dispatchEvent(new CustomEvent(b,{detail:c}))}function e(){var a=navigator.userAgent.indexOf("Trident")!=-1&&navigator.userAgent.indexOf("MSIE")==-1,b=navigator.userAgent.indexOf("MSIE")!=-1;return a||b}var f={},g=[];return f.setup=function(a,c,d,e){d?(f.map=d,f.elementId="map"):(f.map=new b.Map(a),f.elementId=a,b.tileLayer("https://api.tiles.mapbox.com/v4/kiezatlas.pd8lkp64/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoia2llemF0bGFzIiwiYSI6ImNpa3BndjU2ODAwYm53MGxzM3JtOXFmb2IifQ._PcBhOcfLYDD8RP3BS0U_g",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &#169; <a href="http://mapbox.com">Mapbox</a>',id:"kiezatlas.m7222ia5"}).addTo(f.map)),b.Util.setOptions(f.map,{dragging:!0,touchZoom:!0,scrollWheelZoom:!1,doubleClickZoom:!0,zoomControl:!1,minZoom:9}),f.map.setMaxBounds(mapping.max_bounds),b.control.scale({imperial:!1,updateWhenIdle:!0}).addTo(f.map),f.map.on("locationfound",f.on_browser_location_found),f.map.on("locationerror",f.on_browser_location_error),f.map.on("dragend",f.on_map_drag_end),f.map.on("drag",f.on_map_drag),mapping.control_group.addTo(f.map),f.map.setView(f.get_current_location_coords(),e?e:mapping.zoom_kiez),f.map.on("zoomend",function(a){mapping.marker_radius_fixed||(f.map.getZoom()<=12?(mapping.marker_radius=7,mapping.marker_radius_selected=11):13===f.map.getZoom()?(mapping.marker_radius=9,mapping.marker_radius_selected=13):14===f.map.getZoom()?(mapping.marker_radius=11,mapping.marker_radius_selected=15):15===f.map.getZoom()?(mapping.marker_radius=12,mapping.marker_radius_selected=17):f.map.getZoom()>=16&&(mapping.marker_radius=14,mapping.marker_radius_selected=19),f.update_geo_object_marker_radius(),f.fire_zoom_end(a))})},f.fit_to_height=function(b){var c=window.innerHeight;b&&(c-=b),a("#"+f.elementId).height(c),f.map.invalidateSize()},f.set_zoom=function(a){f.map.setZoom(a)},f.clear_marker=function(){mapping.marker_group&&(mapping.marker_group.eachLayer(function(a){f.map.removeLayer(a)}),f.map.removeLayer(mapping.marker_group),mapping.marker_group=void 0)},f.render_circle_search_control=function(c){mapping.circle_search_control&&mapping.control_group.removeLayer(mapping.circle_search_control),f.is_circle_query_active()&&(mapping.circle_search_control=new b.CircleEditor(f.get_current_location_coords(),mapping.circle_search_radius,{color:colors.ka_gold,weight:3,opacity:.4,extendedIconClass:"extend-icon-medium",className:"leaflet-search-control",clickable:!1,zIndexOffset:101,fillColor:colors.ka_gold}),mapping.control_group.addLayer(mapping.circle_search_control),mapping.circle_search_control.on("edit",function(a){var b=a.target._mRadius;f.set_current_location_coords(a.target._latlng),f.fire_circle_edit(b)}),c&&f.map.fitBounds(mapping.control_group.getBounds(),{padding:[30,30]}),f.is_circle_control_fixed()&&a(".leaflet-editing-icon").hide())},f.remove_circle_search_control=function(){mapping.circle_search_control&&mapping.control_group.removeLayer(mapping.circle_search_control)},f.render_geo_objects=function(a){var c=[],d="id";f.is_angebote_mode()&&(d="location_id");var e=f.get_items();for(var g in e){var h=e[g];if("null"!==h&&h){if(!f.exist_marker_in_listing(h,c,d)){var i=f.create_geo_object_marker(h);i&&c.push(i)}}else console.warn("Skipping Geo Object View Model ["+g+"]",h)}mapping.marker_group&&mapping.marker_group.eachLayer(function(a){f.exist_marker_in_listing(a.options,c,d)||c.push(a)}),f.clear_marker(),mapping.do_cluster_marker?(mapping.marker_group=b.markerClusterGroup({spiderfyOnMaxZoom:!0,spiderfyDistanceMultiplier:2,showCoverageOnHover:!1,maxClusterRadius:60}),mapping.marker_group.addLayers(c),mapping.marker_group.on("clusterclick",function(a){console.log("Clusterclick",a)})):mapping.marker_group=b.featureGroup(c);for(var g in c){var j=c[g];mapping.marker_group.addLayer(j)}f.map.addLayer(mapping.marker_group),a&&c.length>0&&f.map.fitBounds(mapping.marker_group.getBounds(),{padding:[30,30]})},f.create_geo_object_marker=function(a){if(a.hasOwnProperty("latitude")&&a.hasOwnProperty("longitude")){var c=a;if(a.latitude>90||a.longitude>180||a.latitude<-90||a.longitude<-180)return void console.warn("Invalid WGS 84 coordinates spotted at",a);if(a.longitude<10||a.latitude<45||a.longitude>15||a.latitude>55)return void console.warn("WGS 84 coordinates do look strange in case of Berlin",a);if(""===a.bezirksregion_uri&&""===a.bezirk_uri)return void console.warn("Invalid Geo Object - Missing Bezirksregion & Bezirk URI",a.name);var d=b.latLng(c.latitude,c.longitude),e=b.circleMarker(d,f.calculate_default_circle_options(c));return e.setRadius(mapping.marker_radius),e.on("click",function(a){f.select_geo_object_marker(a.target)}),e.on("mouseover",function(a){e.setRadius(mapping.marker_radius+5),e.setStyle(f.calculate_hover_circle_options()),f.fire_marker_mouseover(a)}),e.on("mouseout",function(a){"selected"!==a.target.options.className&&(e.setRadius(mapping.marker_radius),e.setStyle(f.calculate_default_circle_options(c))),f.fire_marker_mouseout(a)}),e}return void console.warn("Could not geo object marker caused by missing geo coordinates")},f.update_geo_object_marker_radius=function(){mapping.marker_group&&mapping.marker_group.eachLayer(function(a){var b=a.options.id;b&&a.setRadius(mapping.marker_radius)})},f.highlight_geo_object_marker_by_id=function(a,b){mapping.marker_group.eachLayer(function(c){var d=c.options.id;if(d==a)mapping.do_cluster_marker||(c.setStyle(f.calculate_selected_circle_options()),c.bringToFront(),c.setRadius(mapping.marker_radius_selected)),b&&f.map.setView(c.getLatLng(),mapping.zoom_street);else{var e={name:c.options.name,bezirksregion_uri:c.options.bezirksregion_uri,uri:c.options.uri,angebote_count:c.options.angebote_count,angebots_id:c.options.angebots_id,id:d,address_id:c.options.address_id,location_id:c.options.location_id,address:c.options.address};c.setStyle(f.calculate_default_circle_options(e)),c.setRadius(mapping.marker_radius)}})},f.select_geo_object_marker=function(a){if(mapping.marker_group.eachLayer(function(a){var b=a.options.id;if(b){var c={name:a.options.name,bezirksregion_uri:a.options.bezirksregion_uri,uri:a.options.uri,angebote_count:a.options.angebote_count,angebots_id:a.options.angebots_id,id:b,address_id:a.options.address_id,location_id:a.options.location_id,address:a.options.address};a.setStyle(f.calculate_default_circle_options(c)),a.setRadius(mapping.marker_radius)}dummyObject=a.options}),a.setStyle(f.calculate_selected_circle_options()),a.bringToFront(),a.setRadius(mapping.marker_radius_selected),a.options.angebots_id)f.fire_angebot_marker_select(a);else{var b=f.find_all_geo_objects(a.options.address_id);f.fire_geo_marker_select(b)}},f.calculate_default_circle_options=function(a){var b=a.hasOwnProperty("angebots_id")?a.angebots_id:void 0;return{fillColor:model.colors.ka_yellow,color:model.colors.blue3,fillOpacity:.4,lineCap:"square",weight:2,title:a.name,name:a.name,alt:"Markierung von "+a.name,bezirk_uri:a.bezirk_uri,uri:a.uri,bezirksregion_uri:a.bezirksregion_uri,z_indexOffset:1001,uri:a.uri,angebote_count:a.angebote_count,angebots_id:b,address:a.address,id:a.id,address_id:a.address_id,location_id:a.location_id}},f.calculate_selected_circle_options=function(){return{color:model.colors.blue3,weight:3,opacity:1,fillColor:model.colors.blue2,fillOpacity:1,className:"selected"}},f.calculate_hover_circle_options=function(){return{color:model.colors.blue3,weight:3,opacity:1,fillColor:model.colors.ka_yellow,fillOpacity:1,className:"hover"}},f.calculate_geo_object_dash_array=function(a){var b=a.angebote_count;return 0===b?[100]:1===b?[2,75]:2===b?[2,5,2,70]:3===b?[2,5,2,5,2,65]:4===b?[2,5,2,5,2,5,2,60]:5===b?[2,5,2,5,2,5,2,5,2,55]:6===b?[2,5,2,5,2,5,2,5,2,5,2,50]:7===b?[2,5,2,5,2,5,2,5,2,5,2,5,2,45]:8===b?[2,5,2,5,2,5,2,5,2,5,2,5,2,5,2,40]:9===b?[2,5,2,5,2,5,2,5,2,5,2,5,2,5,2,5,2,40]:b>9?[2,5]:void 0},f.is_initialized=function(){return!!f.map},f.deactivate_circle_control=function(){mapping.circle_query=!1},f.activate_circle_control=function(){mapping.circle_query=!0},f.set_circle_control_fixed=function(a){return mapping.circle_locked=a},f.is_circle_control_fixed=function(){return mapping.circle_locked},f.is_circle_query_active=function(){return mapping.circle_query},f.set_angebote_mode=function(a){mapping.angebote_mode=a},f.is_angebote_mode=function(){return mapping.angebote_mode},f.scroll_into_view=function(a){a?document.getElementById(a).scrollIntoView():document.getElementById(f.elementId).scrollIntoView()},f.set_items=function(a){g=a},f.get_items=function(){return g},f.get_circle_control_radius=function(){return mapping.circle_search_control?mapping.circle_search_control.getRadius():mapping.circle_search_radius},f.set_circle_control_radius=function(a){mapping.circle_search_radius?mapping.circle_search_radius=a:console.warn("Circle Search Control is curerntly INACTIVE")},f.get_circle_control_bounds=function(){return mapping.circle_search_control.getBounds()},f.set_map_center=function(a){return f.map.setView(a)},f.pan_to=function(a){return f.map.panTo(a)},f.get_map_center=function(){return f.map.getCenter()},f.get_map_viewport=function(){if(f.map)return{bounds:f.map.getBounds(),zoom:f.map.getZoom(),center:f.map.getCenter()}},f.set_map_fit_bounds=function(a){return f.map.fitBounds(a)},f.get_current_location=function(){return mapping.current_location},f.get_current_location_name=function(){return mapping.current_location.name},f.get_current_location_coords=function(){return mapping.current_location.coordinate},f.get_current_location_lat=function(){return mapping.current_location.coordinate.lat},f.get_current_location_lng=function(){return mapping.current_location.coordinate.lng},f.set_current_location=function(a){mapping.current_location=a},f.set_marker_radius=function(a){mapping.marker_radius=a},f.set_marker_fixed_radius=function(a){mapping.marker_radius_fixed=a},f.set_marker_selected_radius=function(a){mapping.marker_radius_selected=a},f.set_current_location_name=function(a){mapping.current_location.name=a},f.set_current_location_coords=function(a){mapping.current_location.coordinate=a},f.get_item_by_id=function(a){var b=f.get_items();for(var c in b){var d=b[c];if(d){if(d.id===a)return d}else console.warn("Geo Object View Model NOT in Map Items",d)}},f.find_all_geo_objects=function(a){var b=[];return a&&mapping.marker_group.eachLayer(function(c){c.options.address_id===a&&b.push(c)}),b},f.exist_marker_in_listing=function(a,b,c){if(b)for(var d in b){if(!a[c])return console.error("marker has no",c,"property",a),!1;if(b[d].options[c]===a[c])return!0}return!1},f.listen_to=function(a,b){var c=document.getElementById(f.elementId);c.addEventListener(a,b)},f.fire_drag_end=function(a){var b=document.getElementById(f.elementId);d(b,"drag_end",a.distance)},f.fire_zoom_end=function(a){var b=document.getElementById(f.elementId);d(b,"zoom_end",a)},f.fire_drag=function(){var a=document.getElementById(f.elementId);d(a,"drag")},f.fire_geo_marker_select=function(a){console.log("fire geo marker select",f.elementId);var b=document.getElementById(f.elementId);d(b,"marker_select",a)},f.fire_angebot_marker_select=function(a){var b=document.getElementById(f.elementId);d(b,"angebot_marker_select",a)},f.fire_marker_mouseover=function(a){var b=document.getElementById(f.elementId);d(b,"marker_mouseover",a)},f.fire_marker_mouseout=function(a){var b=document.getElementById(f.elementId);d(b,"marker_mouseout",a)},f.fire_circle_edit=function(a){var b=document.getElementById(f.elementId);d(b,"circle_control_edit",a)},f.fire_location_found=function(a){var b=document.getElementById(f.elementId);d(b,"locating_success",a)},f.fire_location_error=function(a){var b=document.getElementById(f.elementId);d(b,"locating_error",a)},f.on_map_drag=function(a){f.fire_drag()},f.on_map_drag_end=function(a){f.fire_drag_end(a)},f.on_browser_location_found=function(a){f.scroll_into_view(),mapping.max_bounds.contains([a.latitude,a.longitude])?f.fire_location_found({latitude:a.latitude,longitude:a.longitude}):c()},f.on_browser_location_error=function(a){f.scroll_into_view(),c()},f}($,L),favourites=function(a,b){function c(a){f.allDocs({include_docs:!0}).then(function(b){var c=parseInt(b.total_rows);a("place_"+c)}).catch(function(a){console.warn(a)})}function d(){var a=navigator.userAgent.indexOf("Trident")!=-1&&navigator.userAgent.indexOf("MSIE")==-1,b=navigator.userAgent.indexOf("MSIE")!=-1;return a||b}console.log("Favourites API Script loaded...");var e={},f=void 0;return e.is_available=function(){return!d()&&"undefined"!=typeof b},e.start_local_db=function(){e.is_available()?f=new b("kiezatlas_favourites"):console.log("Could not start PouchDB, possible we're on the MS IE")},e.list_entries_in_local_db=function(){f&&f.allDocs({include_docs:!0,descending:!0}).then(function(b){if(b.total_rows>0){a("#places .entries").empty();for(var c in b.rows){var d=b.rows[c];if("undefined"!=typeof d.doc.data){var e=a('<li class="ui-menu-item submenu-item"><a id="'+d.doc._id+'" href="#">'+d.doc.data.name+"</a></li>");e.click(function(a){f.get(a.target.id).then(function(a){kiezatlas.show_favourite_location(a.data)}).catch(function(a){console.warn(a)})}),a("#places .entries").append(e)}else console.warn("Uncorrect entry",d)}a("#places").menu({icons:{submenu:"ui-icon-grip-dotted-horizontal"}}),a("#places").show(),a("button.star").removeClass("no-favs")}}).catch(function(a){console.log(a)})},e.add_entry_to_local_db=function(a){f&&c(function(b){var c={_id:b,data:a};f.put(c),e.list_entries_in_local_db()})},e}($,PouchDB),angebote=function(a){var b={},c=[];return b.load_geo_objects_angebote=function(b){var d="",e=1;for(var f in b)d+=b[f],e<b.length&&(d+=";"),e++;a.ajax("/angebote/list/many/"+d,{type:"GET",error:function(a){console.warn("AJAX POST Error",a),200===a.status&&(c=response)},success:function(a){c=a}})},b.get_angebotsinfos_by_geo_object_id=function(a){var b=[];for(var d in c){var e=c[d];e.assoc.role_1.topic_id!==a&&e.assoc.role_2.topic_id!==a||b.push(e)}return b},b.show_angebotsinfos=function(c){var d=b.get_angebotsinfos_by_geo_object_id(c),e=a("#details-"+c+" .angebote-listing");0===e.children().length&&(e=a('<div class="angebote-listing">'),a(".angebote-link").append(e)),e.empty();for(var f in d){var g=d[f];console.log("- NYE - Render Angebotsinfo",g)}},b}($),settings={webapp_title:"Kiezatlas 2 Website",history_api_supported:window.history.pushState},updateURL=!0,query=void 0,parameter={page:void 0,viewport:void 0},selected_marker=void 0,month_names_de=["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],colors={ka_blue:"#002856",ka_red:"#8f1414",m_blue:"#5784b8",ka_gold:"#EACA8F",bright_grey:"#a9a9a9",yellow:"#FFCC33",darkgrey:"#343434",blue:"#1944fc",b_blue:"#5a78f3",ka_water:"#ccdddd",grey:"#868686"},kiezatlas=function(a,b,c,d){var e={district:void 0,districts:[],locationsearch_results:[],autocomplete_item:0,view_angebote:!1,site_info:void 0,site_id:void 0,map_controls_results:!1};this.set_district=function(a){e.district=a},this.get_gistrict=function(){return e.district},this.set_site_info=function(a){e.site_info=a},this.set_site_id=function(a){e.site_id=a},this.get_site_info=function(){return e.site_info},this.get_site_id=function(){return e.site_id},this.set_districts=function(a){e.districts=a},this.get_districts=function(){return e.districts},this.set_frontpage_mode=function(){f.set_site_info(void 0),f.set_site_id(void 0)},this.set_angebotsfilter=function(a){e.view_angebote=a},this.set_mapcontrol_mode_results=function(){e.map_controls_results=!0,b.deactivate_circle_control(),b.remove_circle_search_control()},this.set_mapcontrol_mode_query=function(a){e.map_controls_results=!1,b.is_circle_query_active()?b.render_circle_search_control(a):(b.activate_circle_control(),b.render_circle_search_control(a),console.log("Activating circle query control..."))},this.is_kiezatlas_site=function(){return e.siteId},this.is_map_result_control=function(){return e.map_controls_results},this.is_map_query_control=function(){return!e.map_controls_results},this.is_angebote_mode=function(){return e.view_angebote};var f=this;return this.do_logout=function(){c.logout(),window.document.location.reload()},this.init_page_navigation=function(){settings.history_api_supported&&(window.onpopstate=function(a){if(a.state)if(parameter=a.state,"#gesamt"===parameter.page?parameter.viewport=a.state.viewport:"#angebote"===a.state.page||console.log("Pop Render Districts or Citymap Page",a.state),parameter.viewport){var c=L.latLng(parameter.viewport.center);b.set_zoom(parameter.viewport.zoom),b.pan_to(c),kiezatlas.is_map_query_control()&&(b.set_current_location_coords(c),b.activate_circle_control(),b.render_circle_search_control(),f.do_circle_search(),f.do_reverse_geocode())}else console.log("No Viewport Parameter")})},this.get_search_keywords=function(a){c.load_search_keywords(a,function(b){console.log("Loaded Search Keywords for ",a,"...",b)})},this.push_page_view=function(a){if(settings.history_api_supported){if(a&&parameter){var b="/"+parameter.page+a;window.history.replaceState(parameter,settings.webapp_title,b)}}else console.warn("window.history manipulation not supported",window.navigator);console.log("Pushing page view parameter in ka-website.js")},this.create_viewport_parameter=function(){var a=b.get_map_viewport(),c=void 0;return a&&(c="?koordinate="+a.center.lat.toFixed(5)+","+a.center.lng.toFixed(5)+"&zoomstufe="+a.zoom),c},this.update_page_parameter=function(){f.is_kiezatlas_site()?console.log("Kiezatlas Citymap",f.get_site_id(),f.get_site_info()):f.get_site_id()&&console.log("Kiezatlas Website Mode",f.get_site_id(),f.get_site_info().value),parameter.page="website";var a=f.create_viewport_parameter();f.push_page_view(a)},this.get_map_viewport_from_url=function(){var a=window.location.search.indexOf("&zoomstufe="),b=void 0;a!==-1&&(b=window.location.search.slice(a+"&zoomstufe=".length));var c=window.location.search.indexOf("?koordinate="),d=void 0;if(c!==-1){var e=window.location.search.slice(c+"?koordinate=".length,a);d=L.latLng(e.split(","))}if(d||b)return{center:d,zoom:b}},this.get_page_parameter_from_url=function(){var a=void 0,b=window.location.hash,c=0,d=-1;return window.location.hash.indexOf("?")!==-1&&(c=window.location.hash.indexOf("#"),d=window.location.hash.indexOf("?"),b=window.location.hash.slice(c,d)),{page:b,viewport:a}},this.render_page=function(a){if(a)f.render_gesamtstadtplan();else{parameter=f.get_page_parameter_from_url();var b=window.location.host.indexOf("mitte.")!==-1||window.location.hostname.indexOf("mitte.")!==-1,c=void 0;parameter.page?"#gesamt"===parameter.page?f.render_gesamtstadtplan():"#angebote"===parameter.page?f.show_angebote_page():parameter.page.indexOf("suche")!==-1?f.render_search_page():f.load_district_topics(function(){c=f.get_bezirks_topic_by_hash(parameter.page),c?f.render_bezirkspage(c):(f.render_gesamtstadtplan(),console.warn("Entschudligung, die Seite "+parameter.page+" konnte nicht geladen werden. "))}):b?f.load_district_topics(function(a){c=f.get_bezirks_topic_by_hash("#mitte"),f.render_bezirkspage(c)}):(console.log("Fallback to render Gesamtstadtplan caused by Page Name",a,"Anchor",parameter.page,"and unspecific Subdomain"),f.render_gesamtstadtplan())}},this.render_gesamtstadtplan=function(){parameter.page="#gesamt",parameter.viewport?(b.set_current_location_coords(parameter.viewport.center),f.render_map(!0,{zoom:parameter.viewport.zoom,center:parameter.viewport.center},!1)):f.render_map(!0,void 0,!1),render_district_menu()},this.render_search_page=function(){var b=window.location.hash;if(f.render_map(!1,{zoom:parameter.viewport.zoom,center:parameter.viewport.center},!0),f.load_district_topics(function(a){f.render_district_menu()}),parameter.page.indexOf("#angebotssuche")!==-1){var c=void 0;c=b.indexOf("?")!==-1?b.slice("#angebotssuche=".length,b.indexOf("?")):b.slice("#angebotssuche=".length),a("#fulltext-search").val(c),f.set_angebotsfilter(!0)}else if(parameter.page.indexOf("#ortssuche")!==-1){var c=void 0;c=b.indexOf("?")!==-1?b.slice("#ortssuche=".length,b.indexOf("?")):b.slice("#ortssuche=".length),a("#fulltext-search").val(c),f.set_angebotsfilter(!1)}f.set_mapcontrol_mode_results(),search_fulltext_geo_objects()},this.void=function(){},this.render_bezirkspage=function(a){a?(f.set_site_info(a),f.set_site_id(a.id),f.load_marker_cluster_scripts(),f.render_map(!1,parameter.viewport,!1,!0),f.show_district_page(f.get_site_info().id),f.render_district_menu(a)):console.error("Critical - could not render bezirkspage due to missing bezirkstopic")},this.render_kiezatlas_site=function(a){citymap.render_kiezatlas_site(a)},this.load_marker_cluster_scripts=function(){var a=document.createElement("link");a.setAttribute("href","/de.kiezatlas.website/vendor/leaflet-1.3.1/MarkerCluster.css"),a.setAttribute("rel","stylesheet");var b=document.createElement("link");
b.setAttribute("href","/de.kiezatlas.website/vendor/leaflet-1.3.1/MarkerCluster.Default.css"),b.setAttribute("rel","stylesheet");var c=document.createElement("script");c.setAttribute("src","/de.kiezatlas.website/vendor/leaflet-1.3.1/leaflet.markercluster.js"),document.head.appendChild(a),document.head.appendChild(b),document.head.appendChild(c),mapping.do_cluster_marker=!0},this.render_map=function(a,c,d,e,g){b.is_initialized()||f.setup_map_area("map",e,g),d&&b.scroll_into_view(),a&&f.get_browser_location(),c&&(c.zoom&&b.set_zoom(c.zoom),c.center&&b.pan_to(c.center))},this.handle_bezirks_item_click=function(a){var b=a.target.getAttribute("href");if(0===b.indexOf("/")&&(b=b.substr(1)),console.log("District Menu Item Clicked",b,"onStartseite",frontpage,"ka-website.js"),frontpage&&"#gesamt"===b)kiezatlas.clear_district_page(),render_page("gesamt");else if(frontpage){var c=get_bezirks_topic_by_hash(b);searchContext=c.id,render_page("bezirk")}else window.document.location.assign(window.document.location.origin+"/website"+b)},this.hide_sidebar=function(){$sidebarUi&&$sidebarUi.sidebar("hide")},this.render_district_menu=function(b){var c=f.get_districts(),d=a("#bezirksauswahl");d.empty();var e=a('<a href="#gesamt" id="gesamt" class="item gesamt">Gesamtstadtplan</a>');e.click(f.handle_bezirks_item_click),b||e.addClass("active"),d.append(e);for(var g in c){var h=c[g],i="#"+encodeURIComponent(h.value.toLowerCase()),j=a('<a href="'+i+'" id="'+encodeURIComponent(h.value.toLowerCase())+'" class="item '+i+'">'+h.value+"</a>");b&&h.id===b.id&&j.addClass("active"),i.indexOf("marzahn")!==-1||i.indexOf("reinickendorf")!==-1||i.indexOf("pankow")!==-1?j.addClass("disabled"):j.click(f.handle_bezirks_item_click),d.append(j)}},this.show_angebote_page=function(){f.is_angebote_mode()&&(query=void 0,a("#fulltext-search").val()),f.set_angebotsfilter(!0),f.render_map(!1,void 0,!1,!0),b.set_angebote_mode(!0),f.update_page_parameter(),f.set_fulltext_search_placeholder("Volltextsuche in Angeboten");var d=a("div.legende");0===d.children("a.circle-control").length?d.append('<a class="circle-control" href="javascript:kiezatlas.clear_angebote_page()">Einrichtungssuche</a>'):a("a.circle-control").show(),a("a.lock-control").hide(),a("a.district-control").hide(),a("span.angebote-btn").addClass("bold"),a("span.einrichtungen-btn").removeClass("bold"),f.set_mapcontrol_mode_results(),c.load_current_angebotsinfos(function(a){b.set_angebote_mode(!0),b.clear_marker(),b.set_items(a),b.render_geo_objects(!0)}),f.load_district_topics(function(a){f.render_district_menu()})},this.clear_angebote_page=function(){a("span.einrichtungen-btn").addClass("bold"),a("span.angebote-btn").removeClass("bold"),f.set_fulltext_search_placeholder("Volltextsuche Berlinweit"),a("a.circle-control").hide(),a("a.district-control").hide(),a("a.lock-control").show(),f.set_angebotsfilter(!1),b.set_angebote_mode(!1),b.set_current_location_coords(b.get_map_center()),b.map.setView(b.get_current_location_coords(),mapping.zoom_street),b.activate_circle_control(),b.render_circle_search_control(),f.do_circle_search(void 0,void 0),f.do_reverse_geocode(),f.update_page_parameter()},this.show_district_page=function(d){f.set_site_info(f.get_bezirks_topic_by_id(d));var e=f.get_site_info().html,g=f.get_site_info().value,h=f.get_site_info().newsfeed;a(".location-label .text").html("Berlin "+g),a(".top.menu a.star").hide(),0===a("div.legende").children("a.district-control").length&&a("div.legende").append('<a class="district-control" href="javascript:kiezatlas.clear_district_page()">Bezirksfilter aufheben</a>'),f.set_fulltext_search_placeholder("Volltextsuche für "+g),a("a.lock-control").hide(),a("a.circle-control").hide(),a("#site-area").show("flex"),a("#site-area .content-area").html(e+'<br/><a href="'+f.get_site_info().imprint+'">Impressum</a>'),b.scroll_into_view(),f.set_mapcontrol_mode_results(),f.show_message("Die Volltextsuche liefert ab jetzt nur Ergebnisse aus dem Bezirk <em>"+g+"</em>. W&auml;hlen sie <em>Bezirksfilter aufheben</em> um wieder Berlinweit Einrichtungen zu finden.",7e3),f.update_document_title(void 0,g),f.show_spinning_wheel(),f.show_newsfeed_area(d,h),c.load_district_topics(d,function(a){b.clear_marker(),f.hide_spinning_wheel(),b.set_items(a),parameter.viewport?b.render_geo_objects(!1):b.render_geo_objects(!0)})},this.show_newsfeed_area=function(b,d){c.load_news_items(b,function(b){var c;if(b)if(b.length>0){c="<h2>Neuigkeiten</h2>";for(var e in b)c+='<div class="news-item"><span class="label date">'+f.format_date(b[e].published)+"</span><h3>"+b[e].title+'&nbsp;<a href="'+b[e].link+'" target="_blank">mehr Infos</a></h3></div>'}else c="<h2>Entschuldigen Sie bitte</h2>",c+='<div class="news-item">Der Newsfeed f&uuml;r diese Site (<a target="_blank" href="'+d+'">Link</a>) konnte gerade nicht geladen werden.</div>';else a("#site-area .news-area").hide();a("#site-area .news-area").html(c)})},this.clear_district_page=function(){a("#site-area").hide(),f.clear_district_filter(),mapping.do_cluster_marker=!1,b.set_current_location_coords(b.get_map_center()),f.set_mapcontrol_mode_query(!0),b.set_zoom(mapping.zoom_kiez),f.do_circle_search(void 0,void 0),f.do_reverse_geocode()},this.clear_district_filter=function(){f.set_frontpage_mode(),f.set_fulltext_search_placeholder("Volltextsuche Berlinweit"),a("a.district-control").remove(),a("a.lock-control").show(),b.scroll_into_view()},this.show_favourite_location=function(a){b.is_initialized()||f.setup_map_area("map"),b.set_current_location(a),b.map.setView(b.get_current_location_coords(),mapping.zoom_street),b.activate_circle_control(),b.render_circle_search_control(),f.do_circle_search(void 0,void 0),f.render_current_location_label()},this.setup_map_area=function(c,d,e){var g=a("#map");g.empty(),g.show();var h=a(".top.menu a.star");h.show(),a(".search-option.d").css("display","inline-block"),a("#detail-area").show("inline"),a("div.legende").show(),b.setup(c,d),f.register_map_listeners(),f.render_browser_location_button(),f.render_current_location_label(),e||b.render_circle_search_control()},this.register_map_listeners=function(){var a=!1;b.listen_to("drag",function(a){b.is_circle_control_fixed()&&f.is_map_query_control()&&(b.set_current_location_coords(b.get_map_center()),b.set_circle_control_radius(b.get_circle_control_radius()),b.activate_circle_control(),b.render_circle_search_control(!1))}),b.listen_to("zoom_end",function(a){f.update_page_parameter()}),b.listen_to("drag_end",function(c){c.detail>=8&&b.is_circle_query_active()&&b.is_circle_control_fixed()&&!f.is_kiezatlas_site()&&f.is_map_query_control()&&(f.do_circle_search(void 0,void 0),f.do_reverse_geocode()),a=!0,f.update_page_parameter()}),b.listen_to("marker_select",function(b){f.clear_details_area(),f.show_selected_geo_details(b.detail),a=!0,selected_marker=b}),b.listen_to("angebot_marker_select",function(c){f.clear_details_area();var d=b.find_all_geo_objects(c.detail.options.address_id);f.show_selected_angebot_detail(c.detail,d),a=!0,selected_marker=c}),b.listen_to("marker_mouseover",function(a){var c=b.find_all_geo_objects(a.detail.target.options.address_id);f.show_marker_name_info(c)}),b.listen_to("marker_mouseout",function(a){f.hide_marker_name_info()}),b.listen_to("circle_control_edit",function(c){b.set_circle_control_radius(c.detail),f.do_circle_search(b.get_current_location_coords(),c.detail),f.do_reverse_geocode(),a=!0}),b.listen_to("locating_success",function(c){console.info("location success by browser",window.navigator),a?console.log("Skip locatiing_error as user already interacted with the map",c):(b.set_current_location_coords(new L.latLng(c.detail.latitude,c.detail.longitude)),b.activate_circle_control(),b.render_circle_search_control(),f.do_circle_search(b.get_current_location_coords(),void 0),f.do_reverse_geocode(),f.update_page_parameter())}),b.listen_to("locating_error",function(c){a?console.log("Skip locatiing_error as user already interacted with the map",c):(console.warn("locating error detected by browser",window.navigator),b.render_circle_search_control(),f.render_current_location_label(),f.do_circle_search(void 0,void 0),f.do_reverse_geocode())})},this.focus_locationsearch_result=function(){var a=e.locationsearch_results[e.autocomplete_item];if(!a)throw new Error("Autocomplete item is undefined",a,e.autocomplete_item);mapping.max_bounds.contains([a.geometry.location.lat,a.geometry.location.lng])?(b.scroll_into_view(),b.set_current_location_coords(new L.latLng(a.geometry.location.lat,a.geometry.location.lng)),b.set_circle_control_radius(900),b.set_current_location_name(a.formatted_address),b.activate_circle_control(),b.render_circle_search_control(),b.map.panTo(b.get_current_location_coords()),f.render_current_location_label(),f.do_circle_search(void 0,void 0)):(b.set_current_location_name("Der erste gefundene Standort liegt au&szlig;erhalb von Berlin, bitte w&auml;hlen sie eine der Alternativen rechts:"),f.render_current_location_label(!0),b.scroll_into_view(),b.map.setView(b.get_current_location_coords(),mapping.zoom_street))},this.show_locationsearch_alternatives=function(){var b=e.locationsearch_results[e.autocomplete_item-1],c=e.locationsearch_results[e.autocomplete_item+1],d="",g="";b?(d=a('<a class="prev-location" title="'+b.formatted_address+'"><</a>'),d.click(function(a){e.autocomplete_item=e.autocomplete_item-1,f.focus_locationsearch_result(),f.show_locationsearch_alternatives()})):d=a('<a class="prev-location defused" title=""><</a>'),c?(g=a('<a class="next-location" title="'+c.formatted_address+'">></a>'),g.click(function(a){e.autocomplete_item=e.autocomplete_item+1,f.focus_locationsearch_result(),f.show_locationsearch_alternatives()})):g=a('<a class="next-location defused" title="">></a>'),a("#street-alternatives").html(e.locationsearch_results.length+" Ergebnisse").append(d).append(g),a("#street-alternatives").css("display","inline-block"),a("#street-alternatives").show()},this.render_current_location_label=function(c){var e=b.get_current_location();e.hasOwnProperty("name")||console.warn("Current location has no name"),e.coordinate.hasOwnProperty("lat")||console.warn("Current location has no lat"),e.coordinate.hasOwnProperty("lng")||console.warn("Current location has no lng");var g,h;if(g=b.get_current_location_lat().toFixed(3),h=b.get_current_location_lng().toFixed(3),a(".location-label .text").html(b.get_current_location_name()+" <small>("+g+" N, "+h+" E)</small>"),d.is_available()){var i=a(".top.menu a.star");i.unbind("click"),i.click(function(a){d.add_entry_to_local_db(b.get_current_location())}),c?i.hide():i.show()}var j=b.get_current_location_name();j.indexOf("Ihr Standort liegt")===-1&&f.update_document_title(b.get_current_location_name())},this.show_selected_geo_details=function(b){var d=[],e=a("#map-sidebar");e.empty(),e.show();for(var g in b){var h=b[g].options,i=h.id;e.append('<div class="entry"><h3>'+h.name+'</h3><a href="/website/geo/'+i+'"><i class="icon caret right"></i>mehr Infos</a></div>'),d.push(i),c.load_geo_object_detail(i,function(a){f.render_selected_details_card(a)})}},this.show_selected_angebot_detail=function(a,b){var d=a.options,e={id:d.location_id,name:d.name,address:d.address};c.load_related_angebotsinfos(d.location_id,function(a){f.render_selected_angebot_details_card(a,e)})},this.render_selected_angebot_details_card=function(b,c){var d="";for(var e in b){var f=b[e];d+='<p><a class="ui button olive" href="/angebote/'+f.angebots_id+'" title="mehr Infos zum Angebot">'+f.angebots_name+" ...</a></p>"}a("#detail-area").append('<div class="entry-card" id="details-'+c.id+'"><h3>'+c.name+'</h3><div class="details angebote"><p>'+cleanUpAddress(c.address)+'</p><p class="label">Aktuell '+b.length+" Angebot/e</p>"+d+"</div></div>")},this.render_selected_details_card=function(b){var c=f.get_imprint_html(b),d=b.kontakt,e=b.oeffnungszeiten,g=f.get_lor_link(b),h='<a href="https://fahrinfo.bvg.de/Fahrinfo/bin/query.bin/dn?Z='+b.address_name.toString()+'&REQ0JourneyStopsZA1=2&start=1&pk_campaign=kiezatlas.de"><img src="/de.kiezatlas.website/images/fahrinfo.gif"></a>',i="";b.angebote_count>0&&(i='<div class="angebote-link"><a class="button" href="/website/geo/'+b.id+'">Aktuelle Angebote anzeigen</a></div>'),f.get_site_info()&&!f.get_site_info().fahrinfoLink&&(h="",console.log("Fahrinfo Link Disabled"));var j="";if("undefined"!=typeof d&&d.value.length>0){var k="<br/>";d.childs.hasOwnProperty("ka2.kontakt.telefon")&&d.childs["ka2.kontakt.telefon"].value.length>0&&(k+="Tel.: "+d.childs["ka2.kontakt.telefon"].value+"<br/>"),d.childs.hasOwnProperty("ka2.kontakt.fax")&&d.childs["ka2.kontakt.fax"].value.length>0&&(k+="Fax: "+d.childs["ka2.kontakt.fax"].value),j+="<p><b>Kontakt</b> "+k+"</p>"}"undefined"!=typeof e&&e.length>0&&(j+="<p><b>&Ouml;ffnungszeiten</b>"+e+"</p>");var l=b.unconfirmed?" unconfirmed":"";a("#detail-area").append('<div class="entry-card'+l+'" id="details-'+b.id+'"><h3>'+b.name+'</h3><div class="details"><p>'+b.address_name.toString()+"<br/>"+j+"</p>"+i+'<a href="/website/geo/'+b.id+'" title="Zeige Details" class="ui button olive">mehr Infos</a>'+h+"</div>"+g+c+"</div>")},this.load_district_topics=function(a){c.load_districts(function(b){f.set_districts(b.sort(c.value_sort_asc)),a&&a()})},this.show_district_listing=function(){var b=f.get_districts();for(var c in b){var d=b[c],e='<li class="bezirk '+d.uri+'">';e+='<a class="district-button" id="'+d.id+'" title="zur Bezirksseite '+d.value+'" href="javascript:kiezatlas.show_district_page('+d.id+')">'+d.value+"</a>",e+="</li>";var g=a(e);a("ul.bezirke").append(g)}},this.create_location_string=function(a){var c="";return c=a?a.lng.toFixed(4)+", "+a.lat.toFixed(4):b.get_current_location_lng()+", "+b.get_current_location_lat()},this.do_circle_search=function(c,d){f.show_spinning_wheel(),f.set_mapcontrol_mode_query();var e=f.create_location_string(c),g=d;d||(g=b.get_circle_control_radius()),a.getJSON("/website/search/"+encodeURIComponent(e)+"/"+g/1e3,function(a){a.length>0?(b.set_items(a),b.clear_marker(),b.render_geo_objects(!1)):f.show_message("Keine Treffer in diesem Umkreis",2e3),f.hide_spinning_wheel()})},this.do_text_search_geo_objects=function(c,d,e){f.set_mapcontrol_mode_results();var g="/website/search/?search="+c;f.get_site_id()&&(g="/website/search/"+f.get_site_id()+"/?search="+c),f.show_searching_indicator(),f.show_spinning_wheel(),a("span.einrichtungen-btn").addClass("bold"),a("span.angebote-btn").removeClass("bold"),a.getJSON(g,function(a){a.length>0?(b.set_items(a),b.clear_marker(),e?b.render_geo_objects(!0):b.render_geo_objects(!1),f.hide_spinning_wheel(),f.hide_searching_indicator()):(f.hide_spinning_wheel(),f.hide_searching_indicator(),f.show_message("Keine Treffer f&uuml;r diese Suche")),d&&d(a)}),updateURL&&f.update_page_parameter()},this.do_text_search_angebotsinfos=function(c,d){var e="/website/search/angebote?search="+c;f.set_mapcontrol_mode_results(),f.show_spinning_wheel(),a.getJSON(e,function(a){a.length>0?(b.set_items(a),b.clear_marker(),d?b.render_geo_objects(!0):b.render_geo_objects(!1),f.hide_spinning_wheel()):(f.hide_spinning_wheel(),f.show_message("Keine Treffer f&uuml;r diese Suche"))}),updateURL&&f.update_page_parameter()},this.do_reverse_geocode=function(a){c.do_reverse_geocode(b,f)},this.toggle_circle_search_lock_button=function(c){var d=!b.is_circle_control_fixed();b.set_circle_control_fixed(d),d?(f.is_angebote_mode()&&f.clear_angebote_page(),a(".lock-control").text("Umkreissuche"),a(".leaflet-editing-icon").hide()):(a(".leaflet-editing-icon").show(),a(".lock-control").text("Kreis fixieren"))},this.toggle_location_menu=function(b){return b?void a("#nearby-area .options").show():void a("#nearby-area .options").toggle()},this.add_page_input_handler=function(){function b(a){f.render_map(!0,void 0,!0,!0)}a(".sidebar .bezirke .menu a").click(f.handle_bezirks_item_click);var c=a(".search-option.a");c.on("touchend",b),c.on("click",b);var d=a(".search-option.b");d.on("touchend",f.focus_location_input_field),d.on("click",f.focus_location_input_field);var e=a(".search-option.c");e.on("touchend",f.handle_option_c),e.on("click",f.handle_option_c)},this.handle_option_c=function(a){f.render_map(!1,{zoom:mapping.zoom_kiez},!0,!0)},this.handle_option_b=function(a){f.render_map(!1,{zoom:mapping.zoom_street},!0,!0)},this.set_fulltext_search_placeholder=function(b){a("#fulltext-search").attr("placeholder",b)},this.get_fulltext_search_input=function(){return a("#fulltext-search").val()},this.get_top_search_input=function(){return a("#text-search").val()},this.show_marker_name_info=function(b){var c="",d=4;for(var e in b)if(c+="<b>"+b[e].options.name+"</b><br/>",e===d){c+="...";break}var f=a("#marker-name","#map");f.children().length>0?(f.html(c),f.show()):(f=a('<div id="marker-name">'),f.html(c),a("#map").append(f),f.show())},this.hide_marker_name_info=function(){a("#marker-name","#map").hide()},this.focus_location_input_field=function(){f.toggle_location_menu(!0),a("#location-input #near-by").focus()},this.show_spinning_wheel=function(b){b?a("#location-input .spinning-wheel").show():a("#spinning-wheel").show()},this.hide_searching_indicator=function(){a(".ui.search button .icon").removeClass("loading").removeClass("circle").removeClass("notched"),a(".ui.search button .icon").addClass("search")},this.show_searching_indicator=function(){a(".ui.search button .icon").addClass("loading").addClass("circle").addClass("notched"),a(".ui.search button .icon").removeClass("search")},this.hide_spinning_wheel=function(b){b?a("#location-input .spinning-wheel").hide():"none"!==a("#spinning-wheel").css("display")&&a("#spinning-wheel").hide()},this.show_message=function(b,c){a("#notification").show(200,"linear",function(d){b&&a(".message",this).html(b),timer=c?c:4500,setTimeout(function(a){f.hide_message_window(500)},timer)})},this.close_message_window=function(){f.hide_message_window(100)},this.hide_message_window=function(b){a("#notification").hide(b,"linear")},this.render_browser_location_button=function(){var b='<a class="leaflet-control-zoom-loc" href="#" title="Your Location"></a>';a(b).insertBefore(".leaflet-control-zoom-in"),a(".leaflet-control-zoom-loc").click(f.get_browser_location)},this.clear_details_area=function(){a(".search-option.d").remove();var b=a(".entry-card");b.hide(200,"linear",function(){b.remove()})},this.get_browser_location=function(a){navigator.geolocation?("undefined"==typeof a&&(a={setView:!0,maxZoom:mapping.zoom_detail,enableHighAccuracy:!0}),b.map.locate(a)):console.warn("Geolocation is not supported by your browser")},this.get_imprint_html=function(a){var b=f.get_bezirks_topic(a.bezirk_uri),c='<div class="imprint">';return b?c+='<a href="'+b.imprint+'" target="_blank" title="Impressum: Bezirksamt '+b.value+'">Impressum</a></div>':(console.warn("Could not fetch Bezirks Topic by URI",b,a),c+="</div>"),c},this.get_lor_link=function(a){if(!a.hasOwnProperty("lor_id"))return"";var b='<div class="lor-link"><a href="http://sozialraumdaten.kiezatlas.de/seiten/2017/06/?lor='+a.lor_id+'" title="zur Einwohnerstatistik des Raums (LOR Nr. '+a.lor_id+')">Sozialraumdaten</a></div>';return b},this.update_document_title=function(a,b){a&&(window.document.title=a+" - "+settings.webapp_title),b&&(window.document.title=settings.webapp_title+" - "+b)},this.name_sort_asc=function(a,b){var c=a.name,d=b.name;return c.toLowerCase()>d.toLowerCase()?1:c.toLowerCase()<d.toLowerCase()?-1:0},this.get_current_location=function(){return b.get_current_location()},this.get_bezirks_topic=function(a){for(var b in f.get_districts()){var c=f.get_districts()[b];if(c.uri===a)return c}},this.get_bezirks_topic_by_id=function(a){for(var b in f.get_districts())if(f.get_districts()[b].id===a)return f.get_districts()[b]},this.get_bezirks_topic_by_hash=function(a){for(var b in f.get_districts()){var c=f.get_districts()[b],d="#"+encodeURIComponent(c.value.toLowerCase());if(d===a)return c}},this.set_autocomplete_item=function(a){e.autocomplete_item=a},this.get_autocomplete_item=function(){return e.autocomplete_item},this.set_locationsearch_results=function(a){e.locationsearch_results=a},this.get_locationsearch_results=function(){return e.locationsearch_results},this.format_date=function(a){try{var b=new Date(a),c=b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes(),d=(b.getHours()<10?"0"+b.getHours():b.getHours(),""+b.getDate()+"."+month_names_de[b.getMonth()]+" "+b.getFullYear()+", "+b.getHours()+":"+c+" Uhr");return d}catch(a){throw Error(a)}},this}($,leafletMap,restc,favourites),DATA_TOPIC_ID="data-topic-id",display_map=!1,facetTypeDefs=void 0,citymap={init:function(a,b){display_map=!b,js.remove_cookie("dm4_topicmap_id"),citymap.setup_map_area("map",!0),kiezatlas.show_spinning_wheel(),leafletMap.deactivate_circle_control(),leafletMap.remove_circle_search_control(),a.indexOf("stadtteil")!==-1&&(leafletMap.set_marker_radius(10),leafletMap.set_marker_selected_radius(15),leafletMap.set_marker_fixed_radius(!0)),restc.load_website_info(a,function(a){kiezatlas.set_site_id(a.id),kiezatlas.set_site_info(a),kiezatlas.update_document_title(a.value),citymap.render_criteria_menu(a.criterias),a.markercluster&&(console.log("Do Use Markercluster"),kiezatlas.load_marker_cluster_scripts()),a.locationPrompt&&console.log("Do Location Prompt"),a.locationSearch&&console.log("Enable Location Search"),a.fahrinfoLink&&console.log("Render Fahrinfo Link"),citymap.render_info_area(a),kiezatlas.show_newsfeed_area(a.id,a.newsfeed),restc.load_website_geoobjects(a.id,function(a){kiezatlas.hide_spinning_wheel(),leafletMap.set_items(a),leafletMap.render_geo_objects(!0)}),restc.load_website_facets(a.id,function(a){facetTypeDefs=a})})},setup_map_area:function(a,b){var c=$("#map");c.empty(),c.show();var d=$(".top.menu a.star");d.show(),$(".search-option.d").css("display","inline-block"),$("#detail-area").show("inline"),$("div.legende").show(),leafletMap.setup(a,b),leafletMap.listen_to("drag",function(a){leafletMap.is_circle_control_fixed()&&kiezatlas.is_map_query_control()&&(leafletMap.set_current_location_coords(leafletMap.get_map_center()),leafletMap.set_circle_control_radius(leafletMap.get_circle_control_radius()),leafletMap.render_circle_search_control(!1))}),leafletMap.listen_to("drag_end",function(a){a.detail>=8&&leafletMap.is_circle_query_active()&&leafletMap.is_circle_control_fixed()&&kiezatlas.is_map_query_control()&&(kiezatlas.do_circle_search(void 0,void 0),kiezatlas.do_reverse_geocode())}),leafletMap.listen_to("marker_select",function(a){citymap.clear_details_area(),citymap.show_selected_details(a.detail)}),leafletMap.listen_to("marker_mouseover",function(a){var b=leafletMap.find_all_geo_objects(a.detail.target.options.location_id);kiezatlas.show_marker_name_info(b)}),leafletMap.listen_to("marker_mouseout",function(a){kiezatlas.hide_marker_name_info()}),leafletMap.listen_to("circle_control_edit",function(a){kiezatlas.do_circle_search(leafletMap.get_current_location_coords(),a.detail),kiezatlas.do_reverse_geocode()}),leafletMap.listen_to("locating_success",function(a){leafletMap.set_current_location_coords(new L.latLng(a.detail.latitude,a.detail.longitude)),leafletMap.activate_circle_control(),leafletMap.render_circle_search_control(),kiezatlas.do_circle_search(leafletMap.get_current_location_coords(),void 0),leafletMap.set_map_fit_bounds(leafletMap.get_circle_control_bounds()),kiezatlas.do_reverse_geocode()}),leafletMap.listen_to("locating_error",function(a){leafletMap.render_circle_search_control(),kiezatlas.render_current_location_label(),kiezatlas.do_circle_search(void 0,void 0),kiezatlas.do_reverse_geocode()}),kiezatlas.render_browser_location_button(),kiezatlas.render_current_location_label(),leafletMap.render_circle_search_control()},render_mobile:function(){citymap.clear_and_select_places_tab();var a=leafletMap.get_items();for(var b in a)citymap.render_mobile_details_card(a[b]);$("#detail-area .mobile-load").hide()},render_mobile_details_card:function(a){if(null!=obj){var b=a.unconfirmed?" unconfirmed":"";$("#detail-area").append('<div class="entry-card'+b+'" id="details-'+a.id+'"><h3>'+a.name+'</h3><div class="details"><p>'+a.anschrift+'<br/></p><a href="javascript:citymap.show_selected_detail('+a.id+', false)" title="Zeige Details">mehr Infos</a><a href="https://fahrinfo.bvg.de/Fahrinfo/bin/query.bin/dn?Z='+encodeURIComponent(a.anschrift)+'&REQ0JourneyStopsZA1=2&start=1&pk_campaign=kiezatlas.de"><img src="/de.kiezatlas.website/images/fahrinfo.gif"></a></div></div>'),$("#detail-area .mobile-load").show()}},show_selected_details:function(a){var b=[];for(var c in a){var d=a[c].options.id;b.push(d),citymap.show_selected_detail(d,!1)}},clear_and_select_places_tab:function(){$(".tabular.menu .item").tab("change tab","first"),$("#detail-area .search-option.d").remove(),$("#detail-area .entry-card").remove()},show_selected_detail:function(a,b){citymap.clear_and_select_places_tab(),leafletMap.highlight_geo_object_marker_by_id(a,b),restc.load_geo_object_detail(a,function(b){citymap.render_selected_detail(b),restc.load_facetted_geo_object(a,kiezatlas.get_site_id(),function(a){citymap.render_geo_object_facets(a)})})},clear_details_area:function(){$(".search-option.d").remove();var a=$(".entry-card");a.hide(200,"linear",function(){a.remove()})},render_selected_detail:function(a){var b=a.kontakt,c=kiezatlas.get_lor_link(a),d='<a href="https://fahrinfo.bvg.de/Fahrinfo/bin/query.bin/dn?Z='+a.address_name.toString()+'&REQ0JourneyStopsZA1=2&start=1&pk_campaign=kiezatlas.de"><img src="/de.kiezatlas.website/images/fahrinfo.gif"></a>',e="";a.angebote_count>0&&(e='<div class="angebote-link"><a class="button" href="/website/geo/'+a.id+'">Aktuelle Angebote anzeigen</a></div>'),kiezatlas.get_site_info()&&!kiezatlas.get_site_info().fahrinfoLink&&(d="");var f="";if("undefined"!=typeof b&&b.value.length>0){var g="<br/>";b.childs.hasOwnProperty("ka2.kontakt.telefon")&&b.childs["ka2.kontakt.telefon"].value.length>0&&(g+="Tel.: "+b.childs["ka2.kontakt.telefon"].value+"<br/>"),b.childs.hasOwnProperty("ka2.kontakt.fax")&&b.childs["ka2.kontakt.fax"].value.length>0&&(g+="Fax: "+b.childs["ka2.kontakt.fax"].value),f+="<p><b>Kontakt</b>"+g+"</p>"}var h=a.unconfirmed?" unconfirmed":"";$("#detail-area").append('<div class="entry-card'+h+'" id="details-'+a.id+'"><h3>'+a.name+'</h3><div class="details"><p>'+a.address_name.toString()+"<br/>"+f+"</p>"+e+'<div class="facets"></div>'+d+"</div>"+c+"</div>")},render_geo_object_facets:function(a){if(!facetTypeDefs)return void console.warn("Could not load facetTypeDefs",facetTypeDefs);var b=$("#details-"+a.id+" .facets");for(var c in facetTypeDefs){var d=facetTypeDefs[c],e=citymap.get_first_child_type_uri(d),f=d.assoc_defs[0].type_uri,g=d.assoc_defs[0].child_cardinality_uri,h=a.childs[e],i=d.value.indexOf(" Facet")!=-1?d.value.replace(" Facet",""):d.value,j=$('<div class="facet">'+i+"</div>"),k=$('<div class="facet-values">'),l=$('<span class="values">'),m=!0;if(f.indexOf("composition_def")!==-1)g.indexOf("many")!==-1?h.length>0?(l=$('<span class="composition-def-many values">'),h[0]&&l.html(h[0].value)):m=!1:h?(l=$('<span class="composition-def-one values">'),i.indexOf("Link")!==-1&&h.value.indexOf("http")!==-1?l.html('<a target="_blank" href="'+h.value+'">'+h.value+"</a>"):l.html(h.value)):m=!1;else if(f.indexOf("aggregation_def")!==-1)if(g.indexOf("many")!==-1){l=$('<ul class="aggregated-def-many values" id="'+d.uri+'">');for(var c in h){var n=h[c],o=$("<li>"+n.value+"</li>");l.append(o)}0===h.length&&(m=!1)}else l=$('<ul class="aggregated-def-one values" id="'+d.uri+'">'),h?l.append($("<li>"+h.value+"</li>")):m=!1;m&&(k.append(l),j.append(k),b.append(j))}},get_first_child_type_uri:function(a){var b=a.assoc_defs[0];return"dm4.core.child_type"===b.role_2.role_type_uri?b.role_2.topic_uri:b.role_1.topic_uri},render_info_area:function(a){$(".citymap-title").text(a.value),$(".welcome .title").text(a.value),$(".welcome .slogan").text(""),$("#sidebar .imprint").html('<a href="'+a.imprint+'" target="_blank">Impressum</a>'),$(".welcome .logo").attr("src",a.logo).attr("title","Logo "+a.value),$("#sidebar .content-area").html(a.html)},do_citymap_fulltext_search:function(a){kiezatlas.do_text_search_geo_objects(a.trim(),function(a){hide_loading_indicator(),0===$(".tabular.menu #search-tab").length&&$(".tabular.menu").append('<div id="search-tab" class="item" data-tab="third">Suche</div>'),$(".tabular.menu .item").tab("change tab","third");var b=$("#search-area ul.results");a.length>0&&b.empty();for(var c in a){var d=a[c],e=create_list_item(d);e.click(function(a){var b=a.target.getAttribute(DATA_TOPIC_ID);b||(b=a.delegateTarget.getAttribute(DATA_TOPIC_ID)),citymap.show_selected_detail(b,!0)}),b.append(e)}}),show_loading_indicator()},select_criteria:function(a,b){0===$(".tabular.menu #category-tab").length&&$(".tabular.menu").append('<div id="category-tab" class="item" data-tab="fourth">Kategorien</div>'),$("#category-area .title.criteria").text(a),$("#category-area .title.criteria").attr(DATA_TOPIC_ID,b),$("#category-area .title.criteria").unbind("click"),$("#category-area .title.criteria").bind("click",function(c){citymap.select_criteria(a,b)}),$(".tabular.menu .item").tab("change tab","fourth");var c=$("#category-area ul.results");c.removeClass("cats"),c.empty(),restc.load_topics_by_type(b,function(a){for(var b in a){var d=a[b],e=$('<li id="'+d.id+'" data-topic-id="'+d.id+'"><span class="label" data-topic-id="'+d.id+'">'+d.value+"</span></li>");e.click(function(a){var b=a.target.getAttribute(DATA_TOPIC_ID);citymap.select_category(b)}),c.append(e)}})},select_category:function(a){restc.load_geo_objects_by_category(kiezatlas.get_site_id(),a,function(b){var c=$("#category-area ul.results");if(b.length>0){c.addClass("cats"),c.empty();for(var d in b){var e=b[d],f=create_list_item(e);f.click(function(a){var b=a.target.getAttribute(DATA_TOPIC_ID);b||(b=a.delegateTarget.getAttribute(DATA_TOPIC_ID)),citymap.show_selected_detail(b,!0)}),c.append(f)}}else $("#"+a).append('<span class="status">(Keine Treffer)</span>')})},register_page_handlers:function(){$(window).resize(function(){setTimeout(function(){leafletMap.fit_to_height(81),citymap.set_sidebar_height()},350)}),$(".citymap .ui.search input").keyup(function(a){a.target.value.length>=3&&13===a.keyCode&&citymap.do_citymap_fulltext_search(a.target.value)}),$(".citymap .ui.search button").click(function(a){var b=$(".citymap .ui.search input").val();b.length>=3&&citymap.do_citymap_fulltext_search(b)}),leafletMap.listen_to("marker_select",function(a){$(".tabular.menu .item").tab("change tab","first")}),$(".tabular.menu .item").tab()},render_criteria_menu:function(a){var b=$(".criterias");b.empty();var c=$('<ul class="items">');b.append(c);for(var d in a){var e=a[d],f=$("<li>"),g=$('<a id="'+e.uri+'" href="#crit-'+e.id+'">'+e.value+"</a>");g.click(function(a){console.log("Selected Criteria",a.target.text,a.target.id),citymap.select_criteria(a.target.text,a.target.id)}),c.append(f.append(g))}},set_sidebar_height:function(){"none"===$("#karte").css("display")?$("#sidebar").height(window.innerHeight-4):$("#sidebar").height(window.innerHeight-36)}};