<!DOCTYPE html>
<html>
    <head>
        <title>Kiezatlas Website</title>

        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"/>

        <!--link rel="stylesheet" href="/de.kiezatlas.website/vendor/jquery/jquery.mobile.theme-1.3.0.min.css"-->
        <!--link rel="stylesheet" href="/de.kiezatlas.website/vendor/jquery/jquery.mobile-1.3.0.min.css"-->
        <link rel="stylesheet" href="/de.kiezatlas.website/vendor/leaflet/leaflet.css"/>
        <link rel="stylesheet" href="/de.kiezatlas.website/css/sitestyle.css"/>

        <script src="/de.kiezatlas.website/vendor/jquery/jquery-1.9.1.min.js"></script>
        <script src="/de.kiezatlas.website/vendor/leaflet/leaflet.js"></script>
        <script src="/de.kiezatlas.website/vendor/leaflet/L.CircleEditor.js"></script>
        <!--script src="/de.kiezatlas.website/vendor/jquery/jquery.mobile-1.3.0.min.js"></script-->

        <script type="text/javascript">
            
            var kiezatlas = new function () {

                this.alternative_items = [] // near-by search street-alternatives
                this.autocomplete_item = 0
                //
                this.center_coords = [52.5, 13.4]
                this.default_radius = 500; /* radius in meters*/
                this.LEVEL_OF_DETAIL_ZOOM = 15 // the map focus when a mapinternal infoWindow is rendered
                this.LEVEL_OF_STREET_ZOOM = 14 // the map focus when a mapinternal infoWindow is rendered
                this.LEVEL_OF_KIEZ_ZOOM = 13
                this.LEVEL_OF_DISTRICT_ZOOM = 12
                this.LEVEL_OF_CITY_ZOOM = 11
                //
                this.location_circle = undefined
                //
                this.historyApiSupported = window.history.pushState
                //
                this.map = undefined
                // 
                this.markerGroup = undefined
                this.controlGroup = L.layerGroup()
                // model of all geo-domain object in client
                this.items = []
                
                this.query_geo_objects = function (location, radius, success) {
                    kiezatlas.show_spinning_wheel()
                    $.getJSON('/kiezatlas/search/'+encodeURIComponent(location)+'/' + (radius / 1000), 
                        function (geo_objects) {
                            kiezatlas.items = geo_objects
                            if (typeof success !== "undefined") {
                                kiezatlas.clear_markers()
                                kiezatlas.hide_spinning_wheel()
                                success(geo_objects)
                            }
                        })
                }
                
                this.search_geo_objects = function (text, success) {
                    kiezatlas.show_spinning_wheel()
                    $.getJSON('/kiezatlas/search/?search='+encodeURIComponent(text), 
                        function (geo_objects) {
                            kiezatlas.items = geo_objects
                            if (typeof success !== "undefined") {
                                // clear markers after fulltext-search
                                kiezatlas.clear_markers()
                                kiezatlas.hide_spinning_wheel()
                                success(geo_objects, true) // ####
                            }
                        })
                }
                
                this.render_geo_objects = function (data, set_view_to_bounds) {
                    // ### if we do not clear markers (which would be nice), we should not render any duplicates ..
                    var list_of_markers = []
                    for (var el in data) {
                        var result = data[el]
                        if (result.hasOwnProperty("geo_coordinate_lat") && 
                            result.hasOwnProperty("geo_coordinate_lon")) { // client-side sanity check of search results
                            var coordinate = L.latLng(result["geo_coordinate_lat"], result["geo_coordinate_lon"])
                            /** brighter blue #5a78f3, blue: "#1944fc" **/
                            var circle = L.circleMarker(coordinate, {
                                    color: "#FFCC33", strokeOpacity: 1, weight: 2, opacity: .5, fillColor: "#FC3", title: result["name"],
                                    alt: "Markierung von " + result["name"], location_id: result["address_id"],
                                    geo_object_id: result["id"], uri: result["uri"], name: result["name"], riseOnHover: true
                                })
                                // ### Level: 14 > 8px e.g. Level: 13 > 5px
                                circle.setRadius(10)
                                // circle.bindPopup(result.name)
                                circle.on('click', function (e) {
                                    kiezatlas.select_map_entry(e.target)
                                })
                                // ### on hover show name in In-Map detail-window
                            list_of_markers.push(circle)
                        }
                    }
                    // maintain also all previously added markers
                    if (typeof kiezatlas.markerGroup !== "undefined") {
                        kiezatlas.markerGroup.eachLayer(function (marker) {
                            if (!kiezatlas.exist_in_marker_listing(marker.options.geo_object_id, list_of_markers)) {
                                console.log("adding old marker to update featureGroup..", marker.options.geo_object_id)
                                list_of_markers.push(marker)
                            }
                        })
                    }
                    // create updated/new feature/markerGroup
                    kiezatlas.markerGroup = L.featureGroup(list_of_markers)
                    kiezatlas.markerGroup.addTo(kiezatlas.map)
                    if (set_view_to_bounds && list_of_markers.length > 0) {
                        // kiezatlas.map.setMaxBounds(kiezatlas.markerGroup.getBounds())
                        kiezatlas.map.fitBounds(kiezatlas.markerGroup.getBounds())
                    }
                }
                
                this.select_map_entry = function (marker) {
                    kiezatlas.markerGroup.eachLayer(function (el) {
                        el.setStyle({ color: "#FFCC33", fillColor: "#FC3" })
                        if (el.options['geo_object_id'] === marker.options['geo_object_id']) {
                            // ### adding class name to path does not work
                            marker.setStyle({ color: "#1944fc", weight: 3, fillColor: "#1944fc", className: "selected" })
                            // marker.redraw()
                        }
                    })
                    var geo_objects_under_marker = kiezatlas.find_all_geo_objects(marker.options['location_id'])
                    kiezatlas.clear_details_area()
                    kiezatlas.render_selected_details(geo_objects_under_marker)
                }

                this.render_selected_details = function (result_list) {
                    // console.log("> render details for", result_list)
                    for (var i in result_list) {
                        $.getJSON('/kiezatlas/topic/'+result_list[i].options['geo_object_id'],
                            function (geo_object) {
                                if (typeof geo_object !== "undefined") {
                                    // ### complete this
                                    $('#detail-area').append('<div class="entry-card">'
                                        + '<h3>'+geo_object.name+'</h3>'
                                        + '<div class="details"><p>'+geo_object.address_name.toString()+'<br/>...</p></div>'
                                        + '</div>')
                                }
                            }
                        )
                    }
                }
                
                this.clear_markers = function () {
                    kiezatlas.map.eachLayer(function (el) {
                        // ### do not remove control group
                        if (el.hasOwnProperty('options') && el.options.hasOwnProperty('geo_object_id')) {
                            kiezatlas.map.removeLayer(el)
                        }
                        kiezatlas.map.addLayer(kiezatlas.controlGroup)
                    })
                }

                this.clear_details_area = function () {
                    $('#detail-area').empty()
                }

                this.show_spinning_wheel = function () {
                    $('#spinning-wheel').show()
                }

                this.hide_spinning_wheel = function () {
                    $('#spinning-wheel').hide()
                }

                this.find_all_geo_objects = function (coordinate_id) {
                    var results = []
                    kiezatlas.markerGroup.eachLayer(function (el) {
                        if (el.options.location_id === coordinate_id) results.push(el)
                    })
                    return results
                }

                this.exist_in_marker_listing = function (geo_object_id, listing) {
                    if (typeof listing !== "undefined") {
                        for (var i in listing) {
                            if (listing[i].options.geo_object_id === geo_object_id) {
                                console.warn("Skipping to add an (already present) Geo Object ID to marker group list", geo_object_id)
                                return true
                            }   
                        }
                    }
                    return false
                }
            }

            $(document).ready(function(e) {
                //
                var tile_layer = undefined
                //
                kiezatlas.map = new L.Map('map', {
                    dragging: true, touchZoom: true, scrollWheelZoom: false,
                    doubleClickZoom: true, zoomControl: false, minZoom: 9,
                    maxBounds: L.latLngBounds(L.latLng(52.298000, 12.909336), L.latLng(52.715646, 13.817779))
                }).setView(kiezatlas.center_coords, 14)
                tile_layer = L.tileLayer('https://api.tiles.mapbox.com/v4/kiezatlas.m7222ia5/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoia2llemF0bGFzIiwiYSI6InFmRTdOWlUifQ.VjM4-2Ow6uuWR_7b49Y9Eg', {
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                    id: 'kiezatlas.m7222ia5',
                    accessToken: 'pk.eyJ1Ijoia2llemF0bGFzIiwiYSI6InFmRTdOWlUifQ.VjM4-2Ow6uuWR_7b49Y9Eg'
                }).addTo(kiezatlas.map)
                /** var imageUrl = '/de.kiezatlas.website/images/tile_map_development_bg.png',
                    imageBounds = kiezatlas.map.getBounds()
                    L.imageOverlay(imageUrl, imageBounds).addTo(kiezatlas.map); **/
                var eCircle = new L.CircleEditor(kiezatlas.center_coords, kiezatlas.default_radius, {
                    color: "#343434", weight: 3, fillColor: "#FFCC33", /** #666 **/
                    fillOpacity: .1, extendedIconClass: ".extend-icon-medium",
                    className: "leaflet-radius-control", clickable: false
                })
                // 
                new L.control.zoom( { position: "topright" }).addTo(kiezatlas.map)
                // 
                kiezatlas.controlGroup.addLayer(eCircle)
                kiezatlas.controlGroup.addTo(kiezatlas.map)
                // 
                eCircle.on('edit', function (event) {
                    // console.log("Radius control moved/edited to ", event, event.target._latlng, event.target._mRadius)
                    // kiezatlas.clear_markers()
                    // fire new query
                    var new_center = event.target._latlng.lat + "," + event.target._latlng.lng
                    var new_radius = event.target._mRadius
                    kiezatlas.query_geo_objects(new_center, new_radius, kiezatlas.render_geo_objects)
                })
        
                kiezatlas.query_geo_objects(kiezatlas.center_coords, kiezatlas.default_radius, kiezatlas.render_geo_objects)
                
                /** function hover_handler () {
                    if (typeof markerGroup !== "undefined") {
                        markerGroup.eachLayer(function (marker) {
                            // console.log("debug-marker", marker)
                            marker.on('mouseover', function () {
                                marker.openPopup()
                            })
                            marker.on('mouseout', function () {
                                marker.closePopup()
                            })
                        })
                    }
                } **/

            })
            
            function search_fulltext() {
                var query = $("#fulltext").val()
                    query = encodeURIComponent(query, "UTF-8")
                kiezatlas.search_geo_objects(query, kiezatlas.render_geo_objects)
            }
            
            function search_near_by_input () {
                var streetFocus = $("#near-by").val() + ' Berlin'
                    streetFocus = encodeURIComponent(streetFocus, "UTF-8")
                // var locale = "de"; // default set to de if empty by proxy-servlet
                // var body = '{"method": "geoCode", "params": ["'+ streetFocus +'", "...", "'+locale+'"]}'
                $.ajax({
                    type: "GET", url: "/kiezatlas/geocode/" + streetFocus,
                    /** beforeSend: function(xhr) {
                        xhr.setRequestHeader("Content-Type", "application/json")
                        xhr.setRequestHeader("Charset", "UTF-8")
                    }, **/
                    success: function(obj) {
                        kiezatlas.alternative_items = null
                        kiezatlas.alternative_items = obj.results
                        kiezatlas.autocomplete_item = 0

                        if (kiezatlas.alternative_items.length == 1) {
                            // select_current_item()
                            focus_current_item()
                            render_alternatives()
                            if (kiezatlas.alternative_items.length <= 1) {
                                $('#street-alternatives').hide()
                            }
                        } else if (kiezatlas.alternative_items.length > 1) {
                            focus_current_item() // focus the first result
                            render_alternatives()
                        }
                    },
                    error: function(x, s, e) {
                        console.warn("ERROR", "x: " + x + " s: " + s + " e: " + e)
                    }
                })

                function focus_current_item () {
                    var item = kiezatlas.alternative_items[kiezatlas.autocomplete_item]
                    if (typeof item !== "undefined") {
                        kiezatlas.map.setView(new L.latLng(item.geometry.location.lat, item.geometry.location.lng), 
                            15)
                        // update gui (search-input field) to contents of first result entry
                        $("#near-by").val(item['formatted_address'])
                        // Display location
                        if (kiezatlas.location_circle != undefined) {
                            kiezatlas.map.removeLayer(kiezatlas.location_circle);
                        }
                        kiezatlas.location_circle = new L.circle(item.geometry.location, 200, {"stroke": true,
                            "clickable": false, "color": "#dae3f8", "fillOpacity": 0.6, "opacity": 0.8, "weight":10});
                        kiezatlas.map.addLayer(kiezatlas.location_circle, {"clickable" : false});
                    }
                }

                function render_alternatives () {
                    // 
                    var prev_location = kiezatlas.alternative_items[kiezatlas.autocomplete_item - 1]
                    var next_location = kiezatlas.alternative_items[kiezatlas.autocomplete_item + 1]
                    var $prev = ""
                    var $next = ""
                    if (typeof prev_location !== "undefined") {
                        $prev = $('<span class="prev-location btn" title="'+ prev_location['formatted_address'] +'"><</span>')
                        $prev.click(function(e) {
                            kiezatlas.autocomplete_item = kiezatlas.autocomplete_item - 1
                            focus_current_item()
                            render_alternatives()
                        })
                    } else {
                        // empty prev button
                        $prev = $('<span class="prev-location" title=""><</span>')
                    }

                    if (typeof next_location !== "undefined") {
                        $next = $('<span class="next-location btn" title="'+ next_location['formatted_address'] +'">></span>')
                        $next.click(function(e) {
                            kiezatlas.autocomplete_item = kiezatlas.autocomplete_item + 1
                            focus_current_item()
                            render_alternatives()
                        })
                    } else {
                        // empty next button
                        $next = $('<span class="next-location" title="">></span>')
                    }
                    // 
                    $('#street-alternatives').html($prev).append($next)
                        .append(kiezatlas.alternative_items.length + ' Standorte gefunden')
                    $('#street-alternatives').show()
                }
                // if (!checkIfAllCategoriesSelected()) showAllMarker();
            }

        </script>
    </head>
    <body>
        
        <div id="navigation">
            <a href="/" class="active">Home</a>
            <a href="/aktuelles">Aktuelles</a>
            <a href="/projekt">Projektbeschreibung</a>
            <a href="/bezirke">Bezirke</a>
            <a href="/weitere-atlanten">Weitere Atlanten</a>
                <!--a href="/weitere-atlanten/wip">WIP</a-->
                <!--a href="/weitere-atlanten/archiv">Archiv</a-->
            <a href="/dies-und-das">Dies & Das</a>
                <!--a href="/dies-und-das/archiv">Archiv</a-->
            <a href="/tipps-und-tricks">Tipps & Tricks</a>
            <a href="/impressum">Impressum</a>
            <!-- a href="/suche">Suche</a-->
            <a href="/links">Links</a>
            <a href="/kontakt">Kontakt</a>
            <a href="/open-source">Open Source</a>
        </div>
        
        <div id="header">
            <p>
                Im Kiezatlas findest du <b>Einrichtungen</b> und <b>Angebote</b> unterschiedlichster Art in deiner Umgebung.
            </p>
        </div>

        <div id="filter-container">
            <div id="fulltext-input">
                <form action="javascript:search_fulltext()" id="fulltext-form" accept-charset="UTF-8">
                    <label for="fulltext" id="fulltext-label">Volltextsuche</label>
                    <input id="fulltext" type="text" placeholder="Name"></input>
                    <input id="do-search" type="submit" class="btn" value="Ok"></input>
                </form>
            </div>
            <div id="location-input">
                <form action="javascript:search_near_by_input()" id="near-by-form" accept-charset="UTF-8">
                    <label for="near-by" id="near-by-label">In der N&auml;he von</label>
                    <input id="near-by" type="text" placeholder="Stra&szlig;enname / Hnr."></input>
                    <input id="do-nearby" type="submit" class="btn" value="Ok"></input>
                </form>
                <div id="street-alternatives"></div>
            </div>
        </div>

        <div id="map-container">
            <h3>Geographische Auswahl sozialer Einrichtungen in Berlin</h3>
            <div id="message" class="notification">Test test..</div>
            <div id="map" class="fullsize"></div>
            <div id="spinning-wheel">
                <img src="/de.kiezatlas.website/images/ajax-loader.gif" />
            </div>
        </div>

        <div id="detail-area"></div>

        <div id="bottom">
            <p>...</p>
        </div>

    </body>
</html>

