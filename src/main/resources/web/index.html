<!DOCTYPE html>
<html>
    <head>
        <title>Kiezatlas Website</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"/>

        <!--link rel="stylesheet" href="/de.kiezatlas.website/vendor/jquery/jquery.mobile.theme-1.3.0.min.css"-->
        <!--link rel="stylesheet" href="/de.kiezatlas.website/vendor/jquery/jquery.mobile-1.3.0.min.css"-->
        <link rel="stylesheet" href="/de.kiezatlas.website/vendor/leaflet/leaflet.css"/>
        <link rel="stylesheet" href="/de.kiezatlas.website/css/sitestyle.css"/>

        <script src="/de.kiezatlas.website/vendor/pouchdb/pouchdb-3.6.0.min.js"></script>
        <script src="/de.kiezatlas.website/vendor/jquery/jquery-1.9.1.min.js"></script>
        <script src="/de.kiezatlas.website/vendor/leaflet/leaflet.js"></script>
        <script src="/de.kiezatlas.website/vendor/leaflet/L.CircleEditor.js"></script>
        <!--script src="/de.kiezatlas.website/vendor/jquery/jquery.mobile-1.3.0.min.js"></script-->

        <script type="text/javascript">
            
            var kiezatlas = new function () {

                this.default_radius = 750; /* radius in meters*/
                this.radius_control = undefined
                this.max_bounds = L.latLngBounds(L.latLng(52.298000, 12.909336), L.latLng(52.715646, 13.817779))

                this.current_location = { name: "Neuenburger Straße, Berlin", coordinate: new L.latLng(52.5, 13.4) }
                this.alternative_items = [] // near-by search street-alternatives
                this.autocomplete_item = 0
                //
                this.LEVEL_OF_DETAIL_ZOOM = 15 // the map focus when a mapinternal infoWindow is rendered
                this.LEVEL_OF_STREET_ZOOM = 14 // the map focus when a mapinternal infoWindow is rendered
                this.LEVEL_OF_KIEZ_ZOOM = 13
                this.LEVEL_OF_DISTRICT_ZOOM = 12
                this.LEVEL_OF_CITY_ZOOM = 11
                //
                this.location_circle = undefined
                //
                this.historyApiSupported = window.history.pushState
                //
                this.map = undefined
                // 
                this.markerGroup = undefined
                this.controlGroup = L.featureGroup()
                // model of all geo-domain object in client
                this.items = []
                this.db = undefined

                this.start_local_db = function () {
                    db = new PouchDB('kiezatlas_favourites')
                    console.log("Started local storage wrapper (PouchDB)!")
                }

                this.update_current_location_label = function (enforceQuery) {
                    //
                    var latitude, longitude;
                        latitude = kiezatlas.current_location.coordinate.lat
                        longitude = kiezatlas.current_location.coordinate.lng
                    // ### sanity check for bigger berlin area before firing a range-query...
                    $('.location-label').html(kiezatlas.current_location.name
                        + ' <small>('+latitude+' N, '+longitude+' E)</small>')
                    if (enforceQuery) {
                        // update radius control too
                        kiezatlas.render_radius_control(true)
                        // then fire query
                        kiezatlas.query_geo_objects(undefined, undefined, kiezatlas.render_geo_objects)
                    }
                }

                this.render_radius_control = function (fitBounds) {
                    // setup radius control
                    if (typeof kiezatlas.radius_control !== "undefined") {
                        kiezatlas.controlGroup.removeLayer(kiezatlas.radius_control)
                        kiezatlas.map.removeLayer(kiezatlas.controlGroup)
                    }
                    kiezatlas.radius_control = new L.CircleEditor(kiezatlas.current_location.coordinate, kiezatlas.default_radius, {
                        color: "#343434", weight: 3, fillColor: "#FFCC33", /** #666 **/
                        fillOpacity: .1, extendedIconClass: "extend-icon-medium",
                        className: "leaflet-radius-control", clickable: false
                    })
                    // add raduis control to map
                    kiezatlas.controlGroup.addLayer(kiezatlas.radius_control)
                    kiezatlas.controlGroup.addTo(kiezatlas.map)
                    // add event handler to radius control
                    kiezatlas.radius_control.on('edit', function (event) {
                        // fire new query
                        var new_radius = event.target._mRadius
                        kiezatlas.current_location.lat = event.target._latlng.lat
                        kiezatlas.current_location.lng = event.target._latlng.lng
                        // ### on small screens (here, after dragging) our current center should be the mapcenter (fitBounds..)
                        kiezatlas.query_geo_objects(event.target._latlng, new_radius, kiezatlas.render_geo_objects)
                        kiezatlas.reverse_geocode()
                    })
                    // update viewport to the programmatically set radius-control
                    if (typeof fitBounds !== "undefined") {
                        // kiezatlas.map.fitBounds(kiezatlas.controlGroup.getBounds())
                        kiezatlas.map.setView(
                            kiezatlas.controlGroup.getBounds().getCenter(),
                            kiezatlas.LEVEL_OF_STREET_ZOOM)
                    }
                }

                this.query_geo_objects = function (location, radius, success) {
                    kiezatlas.show_spinning_wheel()
                    var location_string = ''
                    var radius_value = kiezatlas.default_radius
                    if (typeof location === "undefined") {
                        location_string = kiezatlas.current_location.coordinate.lng + ', '+kiezatlas.current_location.coordinate.lat
                    } else {
                        location_string = location.lng + ', '+location.lat
                    }
                    if (typeof radius !== "undefined") radius_value = radius
                    $.getJSON('/kiezatlas/search/'+encodeURIComponent(location_string)+'/' + (radius_value / 1000),
                        function (geo_objects) {
                            kiezatlas.items = geo_objects
                            if (typeof success !== "undefined") {
                                kiezatlas.clear_markers()
                                kiezatlas.hide_spinning_wheel()
                                success(geo_objects)
                            }
                        })
                }

                this.search_geo_objects = function (text, success) {
                    kiezatlas.show_spinning_wheel()
                    $.getJSON('/kiezatlas/search/?search='+encodeURIComponent(text), 
                        function (geo_objects) {
                            kiezatlas.items = geo_objects
                            if (typeof success !== "undefined") {
                                // clear markers after fulltext-search
                                kiezatlas.clear_markers()
                                kiezatlas.hide_spinning_wheel()
                                success(geo_objects, true) // ####
                            }
                        })
                }

                this.render_geo_objects = function (data, set_view_to_bounds) {
                    // ### if we do not clear markers (which would be nice), we should not render any duplicates ..
                    var list_of_markers = []
                    for (var el in data) {
                        var result = data[el]
                        if (result.hasOwnProperty("geo_coordinate_lat") && 
                            result.hasOwnProperty("geo_coordinate_lon")) { // client-side sanity check of search results
                            var coordinate = L.latLng(result["geo_coordinate_lat"], result["geo_coordinate_lon"])
                            /** brighter blue #5a78f3, blue: "#1944fc" **/
                            var circle = L.circleMarker(coordinate, {
                                    color: "#FFCC33", strokeOpacity: 1, weight: 2, opacity: .5, fillColor: "#FC3", title: result["name"],
                                    alt: "Markierung von " + result["name"], location_id: result["address_id"],
                                    geo_object_id: result["id"], uri: result["uri"], name: result["name"],// riseOnHover: true,
                                    bezirksregion_uri: result["bezirksregion_uri"]
                                })
                                // ### Level: 14 > 8px e.g. Level: 13 > 5px
                                circle.setRadius(10)
                                // circle.bindPopup(result.name)
                                circle.on('click', function (e) {
                                    kiezatlas.select_map_entry(e.target)
                                })
                                // ### on hover show name in In-Map detail-window
                            list_of_markers.push(circle)
                        }
                    }
                    // maintain also all previously added markers
                    if (typeof kiezatlas.markerGroup !== "undefined") {
                        kiezatlas.markerGroup.eachLayer(function (marker) {
                            if (!kiezatlas.exist_in_marker_listing(marker.options.geo_object_id, list_of_markers)) {
                                list_of_markers.push(marker)
                            }
                        })
                    }
                    // create updated/new feature/markerGroup
                    kiezatlas.markerGroup = L.featureGroup(list_of_markers)
                    kiezatlas.markerGroup.addTo(kiezatlas.map)
                    if (set_view_to_bounds && list_of_markers.length > 0) {
                        // kiezatlas.map.setMaxBounds(kiezatlas.markerGroup.getBounds())
                        kiezatlas.map.fitBounds(kiezatlas.markerGroup.getBounds())
                    }
                }
                
                this.select_map_entry = function (marker) {
                    kiezatlas.markerGroup.eachLayer(function (el) {
                        el.setStyle({ color: "#FFCC33", fillColor: "#FC3" })
                        if (el.options['geo_object_id'] === marker.options['geo_object_id']) {
                            // ### adding class name to path does not work
                            marker.setStyle({ color: "#1944fc", weight: 3, fillColor: "#1944fc", className: "selected" })
                            // marker.redraw()
                        }
                    })
                    var geo_objects_under_marker = kiezatlas.find_all_geo_objects(marker.options['location_id'])
                    kiezatlas.clear_details_area()
                    kiezatlas.render_selected_details(geo_objects_under_marker)
                }

                this.render_selected_details = function (result_list) {
                    // console.log("> render details for", result_list)
                    for (var i in result_list) {
                        $.getJSON('/kiezatlas/topic/'+result_list[i].options['geo_object_id'],
                            function (geo_object) {
                                if (typeof geo_object !== "undefined") {
                                    // linkage works
                                    var web_alias = geo_object.bezirksregion_uri.slice(18)
                                    var topic_id = geo_object.uri.slice(19)
                                    $('#detail-area').append('<div class="entry-card">'
                                        + '<h3>'+geo_object.name+'</h3>'
                                        + '<div class="details"><p>'+geo_object.address_name.toString() + '<br/>...'
                                        + '</p>'
                                        + '<a href="http://www.kiezatlas.de/map/'+web_alias+'/p/'+topic_id+'">Mehr Infos im Stadtplan</a>'
                                        + '<a href="https://fahrinfo.bvg.de/Fahrinfo/bin/query.bin/dn?Z='+geo_object.address_name.toString()+'&REQ0JourneyStopsZA1=2&start=1&pk_campaign=kiezatlas.de"><img src="/de.kiezatlas.website/images/fahrinfo.gif"></a>'
                                        + '</div>'
                                    + '</div>')
                                }
                            }
                        )
                    }
                }
                
                this.clear_markers = function () {
                    kiezatlas.map.eachLayer(function (el) {
                        // ### do not remove control group
                        if (el.hasOwnProperty('options') && el.options.hasOwnProperty('geo_object_id')) {
                            kiezatlas.map.removeLayer(el)
                        }
                        kiezatlas.map.addLayer(kiezatlas.controlGroup)
                    })
                }

                this.clear_details_area = function () {
                    $('#detail-area').empty()
                }

                this.show_spinning_wheel = function (isLocating) {
                    if (isLocating) {
                        $('#location-input .spinning-wheel').show()
                    } else {
                        $('#spinning-wheel').show()
                    }
                }

                this.hide_spinning_wheel = function (isLocating) {
                    if (isLocating) {
                        $('#location-input .spinning-wheel').hide()
                    } else {
                        $('#spinning-wheel').hide()
                    }
                }

                this.find_all_geo_objects = function (coordinate_id) {
                    var results = []
                    kiezatlas.markerGroup.eachLayer(function (el) {
                        if (el.options.location_id === coordinate_id) results.push(el)
                    })
                    return results
                }

                this.exist_in_marker_listing = function (geo_object_id, listing) {
                    if (typeof listing !== "undefined") {
                        for (var i in listing) {
                            if (listing[i].options.geo_object_id === geo_object_id) {
                                // console.warn("Skipping to add an (already present) Geo Object ID to marker group list", geo_object_id)
                                return true
                            }   
                        }
                    }
                    return false
                }

                this.render_location_button = function () {
                    var locateButton = '<a class="leaflet-control-zoom-loc" href="#" title="Your Location"></a>'
                    $(locateButton).insertBefore(".leaflet-control-zoom-in")
                    $(".leaflet-control-zoom-loc").click(kiezatlas.get_browser_location);
                }

                this.get_browser_location = function (options) {
                    if (typeof options === "undefined") { // ??? do this options work for us?
                        options =  {
                            "setView" : true, "maxZoom" : kiezatlas.LEVEL_OF_DETAIL_ZOOM
                        }
                    }
                    kiezatlas.map.locate(options)
                    kiezatlas.show_spinning_wheel(true)
                }

                this.on_location_found = function (e) {
                    // ### if location NOT berlin, do something smart - does NOT WORK
                    kiezatlas.hide_spinning_wheel(true)
                    if (!kiezatlas.max_bounds.contains([e.latitude, e.longitude])) {
                        kiezatlas.current_location.name = 'Ihr aktueller Standort liegt au&szlig;erhalb '
                            + 'unseres momentanen Einflu&szlig;bereichs. Wir k&ouml;nnen ihnen lediglich Daten aus dem '
                            + 'Gro&szlig;raum Berlin anbieten. Bitte geben sie dazu z.B.: bei <a href="#b">B)</a> einen Stra&szlig;ennamen ein.'
                        kiezatlas.update_current_location_label(false)
                    } else {
                        kiezatlas.current_location.coordinate.lat = e.latitude
                        kiezatlas.current_location.coordinate.lng = e.longitude
                        // ### if location in berlin, do something smart (suggest to save location to favourites'db
                            // ### complete error handling, for geo-name lookup
                        kiezatlas.reverse_geocode()
                    }
                }

                this.reverse_geocode = function (e) {
                    $.getJSON('/kiezatlas/reverse-geocode/' + kiezatlas.current_location.coordinate.lat
                            + ',' + kiezatlas.current_location.coordinate.lng, function (geo_names) {
                        kiezatlas.hide_spinning_wheel(true)
                        if (geo_names.results.length > 0) {
                            var first_result = geo_names.results[0]
                            var components = first_result.address_components
                            var o = { coordinates : "" + kiezatlas.current_location.coordinate.lat + "," + kiezatlas.current_location.coordinate.lng }
                            for (var i in components) {
                                var el = components[i]
                                if (el.types[0] === "route") {
                                    o.street = el.long_name
                                } else if (el.types[0] === "sublocality_level_2") {
                                    o.area = el.long_name
                                } else if (el.types[0] === "locality") {
                                    o.city = el.long_name
                                } else if (el.types[0] === "postal_code") {
                                    o.postal_code= el.long_name
                                }
                            }
                            // console.log("Location detected", o)
                            kiezatlas.current_location.name = o.street + ", " + o.city
                            if (typeof o.area !== "undefined") kiezatlas.current_location.name += " " + o.area
                            kiezatlas.update_current_location_label(false)
                        }
                    })
                }

                this.on_location_error = function (e) {
                    console.og("Location could not be detected, error:", e)
                    kiezatlas.hide_spinning_wheel(true)
                }

            }

            $(document).ready(function(e) {
                // initiate map
                kiezatlas.map = new L.Map('map', {
                    dragging: true, touchZoom: true, scrollWheelZoom: false,
                    doubleClickZoom: true, zoomControl: false, minZoom: 9,
                    maxBounds: kiezatlas.max_bounds
                })
                // custom zoom control
                new L.control.zoom( { position: "topright" }).addTo(kiezatlas.map)
                L.tileLayer('https://api.tiles.mapbox.com/v4/kiezatlas.m7222ia5/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoia2llemF0bGFzIiwiYSI6InFmRTdOWlUifQ.VjM4-2Ow6uuWR_7b49Y9Eg', {
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                    id: 'kiezatlas.m7222ia5',
                    accessToken: 'pk.eyJ1Ijoia2llemF0bGFzIiwiYSI6InFmRTdOWlUifQ.VjM4-2Ow6uuWR_7b49Y9Eg'
                }).addTo(kiezatlas.map)
                /** var imageUrl = '/de.kiezatlas.websites/images/tile_map_development_bg.png',
                    imageBounds = kiezatlas.map.getBounds()
                    L.imageOverlay(imageUrl, imageBounds).addTo(kiezatlas.map) **/
                //
                kiezatlas.update_current_location_label(true) // implicitly queries for geo_objects
                // correct current default viewport
                kiezatlas.map.setView(kiezatlas.current_location.coordinate, kiezatlas.LEVEL_OF_DETAIL_ZOOM)
                // 
                kiezatlas.map.on('locationfound', kiezatlas.on_location_found)
                kiezatlas.map.on('locationerror', kiezatlas.on_location_error)
                kiezatlas.render_location_button()
                kiezatlas.start_local_db()
            })
            
            function search_fulltext() {
                var query = $("#fulltext").val()
                    query = encodeURIComponent(query, "UTF-8")
                kiezatlas.search_geo_objects(query, kiezatlas.render_geo_objects)
            }
            
            function search_near_by_input () {
                var streetFocus = $("#near-by").val() + ' Berlin'
                    streetFocus = encodeURIComponent(streetFocus, "UTF-8")
                kiezatlas.show_spinning_wheel(true)
                $.ajax({
                    type: "GET", url: "/kiezatlas/geocode/" + streetFocus,
                    /** beforeSend: function(xhr) {
                        xhr.setRequestHeader("Content-Type", "application/json")
                        xhr.setRequestHeader("Charset", "UTF-8")
                    }, **/
                    success: function(obj) {
                        kiezatlas.hide_spinning_wheel(true)
                        kiezatlas.alternative_items = null
                        kiezatlas.alternative_items = obj.results
                        kiezatlas.autocomplete_item = 0
                        if (kiezatlas.alternative_items.length == 1) {
                            focus_current_item()
                            render_alternatives()
                            if (kiezatlas.alternative_items.length <= 1) {
                                $('#street-alternatives').hide()
                            }
                        } else if (kiezatlas.alternative_items.length > 1) {
                            focus_current_item() // focus the first result
                            render_alternatives()
                        }
                    },
                    error: function(x, s, e) {
                        console.warn("ERROR", "x: " + x + " s: " + s + " e: " + e)
                        kiezatlas.hide_spinning_wheel(true)
                    }
                })

                function focus_current_item () {
                    var item = kiezatlas.alternative_items[kiezatlas.autocomplete_item]
                    if (typeof item !== "undefined") {
                        kiezatlas.current_location.coordinate = new L.latLng(item.geometry.location.lat, item.geometry.location.lng)
                        kiezatlas.default_radius = 900
                        kiezatlas.current_location.name = item['formatted_address']
                        kiezatlas.update_current_location_label(true)
                        // $("#near-by").val(item['formatted_address'])
                        // Display location
                        /** if (kiezatlas.location_circle != undefined) {
                            kiezatlas.map.removeLayer(kiezatlas.location_circle);
                        }
                        kiezatlas.location_circle = new L.circle(item.geometry.location, 200, {"stroke": true,
                            "clickable": false, "color": "#dae3f8", "fillOpacity": 0.6, "opacity": 0.8, "weight":10});
                        kiezatlas.map.addLayer(kiezatlas.location_circle, {"clickable" : false}); **/
                    }
                }

                function render_alternatives () {
                    // 
                    var prev_location = kiezatlas.alternative_items[kiezatlas.autocomplete_item - 1]
                    var next_location = kiezatlas.alternative_items[kiezatlas.autocomplete_item + 1]
                    var $prev = ""
                    var $next = ""
                    if (typeof prev_location !== "undefined") {
                        $prev = $('<input type="button" class="prev-location" title="'+ prev_location['formatted_address'] +'" value="<" />')
                        $prev.click(function(e) {
                            kiezatlas.autocomplete_item = kiezatlas.autocomplete_item - 1
                            focus_current_item()
                            render_alternatives()
                        })
                    } else {
                        // empty prev button
                        $prev = $('<input type="button" class="prev-location defused" title="" value="<"/>')
                    }

                    if (typeof next_location !== "undefined") {
                        $next = $('<input type="button" class="next-location" title="'+ next_location['formatted_address'] +'" value=">" />')
                        $next.click(function(e) {
                            kiezatlas.autocomplete_item = kiezatlas.autocomplete_item + 1
                            focus_current_item()
                            render_alternatives()
                        })
                    } else {
                        // empty next button
                        $next = $('<input type="button" value=">" class="next-location defused" title=">" />')
                    }
                    // 
                    $('#street-alternatives').html('Mehrere ('+kiezatlas.alternative_items.length+') Orte gefunden')
                            .append($prev).append($next)
                    $('#street-alternatives').show()
                }
                // if (!checkIfAllCategoriesSelected()) showAllMarker();
            }

        </script>
    </head>
    <body>
        
        <div id="navigation">
            <!--
            <a href="/" class="active">Home</a>
            <a href="/aktuelles">Aktuelles</a>
            <a href="/projekt">Projektbeschreibung</a>
            <a href="/bezirke">Bezirke</a>
            <a href="/weitere-atlanten">Weitere Atlanten</a>
                <!--a href="/weitere-atlanten/wip">WIP</a-->
                <!--a href="/weitere-atlanten/archiv">Archiv</a-->
            <!--a href="/dies-und-das">Dies & Das</a-->
                <!--a href="/dies-und-das/archiv">Archiv</a-->
            <!--a href="/tipps-und-tricks">Tipps & Tricks</a>
            <a href="/impressum">Impressum</a>
            <!-- a href="/suche">Suche</a-->
            <!--a href="/links">Links</a>
            <a href="/kontakt">Kontakt</a>
            <a href="/open-source">Open Source</a-->
        </div>
        
        <div id="header">
            <div class="welcome">
                <img src="/de.kiezatlas.website/images/kiezatlas-logo.png" />
                <h3>Willkommen im Kiezatlas!</h3>
                <p>
                    Im Kiezatlas findest du Berliner <i>Einrichtungen</i> und <i>Angebote</i> aus deiner Umgebung.
                    Wir bieten <b>dir drei</b> M&ouml;glickeiten um Infos aus einer bestimmten Gegend abzufragen:
                </p>
            </div>
            <div class="search-option c">
                <h1 id="a">A)</h1>
                <b>Deinen aktuellen Standort freigeben</b><br/>
                Mit Hilfe deines Web-Browsers kannst du einfach per Klick <a href="javascript:kiezatlas.get_browser_location()">deinen aktuellen Standort</a> als Ausgangspunkt f&uuml;r die Umkreissuche benutzen.
            </div>
            <div class="search-option b">
                <h1 id="b">B)</h1>
                <b>Name eines Platzes oder einer Stra&szlig;e eingeben</b><br/>
                Du kannst auch einfach den Namen eines Platzes oder einer Stra&szlig;e in Berlin eingeben.<br/>
                <div id="location-input">
                    <form action="javascript:search_near_by_input()" id="near-by-form" accept-charset="UTF-8">
                        <!-- label for="near-by" id="near-by-label">In der N&auml;he von</label-->
                        <input id="near-by" type="text" placeholder="Stra&szlig;enname / Hnr." />
                        <input id="do-nearby" type="submit" class="btn" value="Ok" />
                        <div class="spinning-wheel">
                            <img src="/de.kiezatlas.website/images/ajax-loader.gif" />
                        </div>
                    </form>
                </div>
            </div>
            <div class="search-option a">
                <h1 id="c">C)</h1>
                <b>Grafische Umkreissuche auf der Karte</b><br/>
                Du kannst den <i>grauen Kreis</i> auf der <a href="#karte">Karte</a> einfach anfassen, <i>verschieben</i> und ggf. vergr&ouml;&szlig;ern. Probier es mal aus!
            </div>
        </div>

        <div id="filter-container">
            <!-- div id="fulltext-input">
                <form action="javascript:search_fulltext()" id="fulltext-form" accept-charset="UTF-8">
                    <label for="fulltext" id="fulltext-label">Volltextsuche</label>
                    <input id="fulltext" type="text" placeholder="Name"></input>
                    <input id="do-search" type="submit" class="btn" value="Ok"></input>
                </form>
            </div-->
        </div>

        <div id="karte">
            <h3 class="location-label"></h3>
            <div id="street-alternatives"></div>
            <div id="message" class="notification">Test test..</div>
            <div id="map" class="fullsize"></div>
            <div id="spinning-wheel">
                <img src="/de.kiezatlas.website/images/ajax-loader.gif" />
            </div>
        </div>

        <div id="detail-area"></div>

        <div id="bottom">
            <p>...</p>
        </div>

    </body>
</html>

